"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _asyncOra = require("@electron-forge/async-ora");

var _pluginBase = _interopRequireDefault(require("@electron-forge/plugin-base"));

var _webMultiLogger = _interopRequireDefault(require("@electron-forge/web-multi-logger"));

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _webpack = _interopRequireDefault(require("webpack"));

var _webpackDevServer = _interopRequireDefault(require("webpack-dev-server"));

var _ElectronForgeLogging = _interopRequireDefault(require("./util/ElectronForgeLogging"));

var _once = _interopRequireDefault(require("./util/once"));

var _WebpackConfig = _interopRequireDefault(require("./WebpackConfig"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const d = (0, _debug.default)('electron-forge:plugin:webpack');
const DEFAULT_PORT = 3000;
const DEFAULT_LOGGER_PORT = 9000;

class WebpackPlugin extends _pluginBase.default {
  constructor(c) {
    super(c);

    _defineProperty(this, "name", 'webpack');

    _defineProperty(this, "isProd", false);

    _defineProperty(this, "projectDir", void 0);

    _defineProperty(this, "baseDir", void 0);

    _defineProperty(this, "_configGenerator", void 0);

    _defineProperty(this, "watchers", []);

    _defineProperty(this, "servers", []);

    _defineProperty(this, "loggers", []);

    _defineProperty(this, "port", DEFAULT_PORT);

    _defineProperty(this, "loggerPort", DEFAULT_LOGGER_PORT);

    _defineProperty(this, "isValidPort", port => {
      if (port < 1024) {
        throw new Error(`Cannot specify port (${port}) below 1024, as they are privileged`);
      } else if (port > 65535) {
        throw new Error(`Port specified (${port}) is not a valid TCP port.`);
      } else {
        return true;
      }
    });

    _defineProperty(this, "exitHandler", (options, err) => {
      d('handling process exit with:', options);

      if (options.cleanup) {
        for (const watcher of this.watchers) {
          d('cleaning webpack watcher');
          watcher.close(() => {});
        }

        this.watchers = [];

        for (const server of this.servers) {
          d('cleaning http server');
          server.close();
        }

        this.servers = [];

        for (const logger of this.loggers) {
          d('stopping logger');
          logger.stop();
        }

        this.loggers = [];
      }

      if (err) console.error(err.stack);
      if (options.exit) process.exit();
    });

    _defineProperty(this, "runWebpack", async (options, isRenderer = false) => new Promise((resolve, reject) => {
      (0, _webpack.default)(options).run(async (err, stats) => {
        if (isRenderer && this.config.renderer.jsonStats) {
          await this.writeJSONStats('renderer', stats, options.stats);
        }

        if (err) {
          return reject(err);
        }

        return resolve(stats);
      });
    }));

    _defineProperty(this, "init", dir => {
      this.setDirectories(dir);
      d('hooking process events');
      process.on('exit', _code => this.exitHandler({
        cleanup: true
      }));
      process.on('SIGINT', _signal => this.exitHandler({
        exit: true
      }));
    });

    _defineProperty(this, "setDirectories", dir => {
      this.projectDir = dir;
      this.baseDir = _path.default.resolve(dir, '.webpack');
    });

    _defineProperty(this, "loggedOutputUrl", false);

    _defineProperty(this, "resolveForgeConfig", async forgeConfig => {
      if (!forgeConfig.packagerConfig) {
        forgeConfig.packagerConfig = {};
      }

      if (forgeConfig.packagerConfig.ignore) {
        console.error(`You have set packagerConfig.ignore, the Electron Forge webpack plugin normally sets this automatically.

Your packaged app may be larger than expected if you dont ignore everything other than the '.webpack' folder`.red);
        return forgeConfig;
      }

      forgeConfig.packagerConfig.ignore = file => {
        if (!file) return false;

        if (this.config.jsonStats && file.endsWith(_path.default.join('.webpack', 'main', 'stats.json'))) {
          return true;
        }

        if (this.config.renderer.jsonStats && file.endsWith(_path.default.join('.webpack', 'renderer', 'stats.json'))) {
          return true;
        }

        return !/^[/\\]\.webpack($|[/\\]).*$/.test(file);
      };

      return forgeConfig;
    });

    _defineProperty(this, "packageAfterCopy", async (_, buildPath) => {
      const pj = await _fsExtra.default.readJson(_path.default.resolve(this.projectDir, 'package.json'));

      if (pj.config) {
        delete pj.config.forge;
      }

      pj.devDependencies = {};
      pj.dependencies = {};
      pj.optionalDependencies = {};
      pj.peerDependencies = {};
      await _fsExtra.default.writeJson(_path.default.resolve(buildPath, 'package.json'), pj, {
        spaces: 2
      });
      await _fsExtra.default.mkdirp(_path.default.resolve(buildPath, 'node_modules'));
    });

    _defineProperty(this, "compileMain", async (watch = false, logger) => {
      let tab;

      if (logger) {
        tab = logger.createTab('Main Process');
      }

      await (0, _asyncOra.asyncOra)('Compiling Main Process Code', async () => {
        const mainConfig = await this.configGenerator.getMainConfig();
        await new Promise((resolve, reject) => {
          const compiler = (0, _webpack.default)(mainConfig);
          const [onceResolve, onceReject] = (0, _once.default)(resolve, reject);

          const cb = async (err, stats) => {
            if (tab && stats) {
              tab.log(stats.toString({
                colors: true
              }));
            }

            if (this.config.jsonStats) {
              await this.writeJSONStats('main', stats, mainConfig.stats);
            }

            if (err) return onceReject(err);

            if (!watch && stats !== null && stats !== void 0 && stats.hasErrors()) {
              return onceReject(new Error(`Compilation errors in the main process: ${stats.toString()}`));
            }

            return onceResolve(undefined);
          };

          if (watch) {
            this.watchers.push(compiler.watch({}, cb));
          } else {
            compiler.run(cb);
          }
        });
      });
    });

    _defineProperty(this, "compileRenderers", async (watch = false) => {
      await (0, _asyncOra.asyncOra)('Compiling Renderer Template', async () => {
        const stats = await this.runWebpack(await this.configGenerator.getRendererConfig(this.config.renderer.entryPoints), true);

        if (!watch && stats !== null && stats !== void 0 && stats.hasErrors()) {
          throw new Error(`Compilation errors in the renderer: ${stats.toString()}`);
        }
      });

      for (const entryPoint of this.config.renderer.entryPoints) {
        if (entryPoint.preload) {
          await (0, _asyncOra.asyncOra)(`Compiling Renderer Preload: ${entryPoint.name}`, async () => {
            await this.runWebpack(await this.configGenerator.getPreloadRendererConfig(entryPoint, entryPoint.preload));
          });
        }
      }
    });

    _defineProperty(this, "launchDevServers", async logger => {
      await (0, _asyncOra.asyncOra)('Launch Dev Servers', async () => {
        const tab = logger.createTab('Renderers');
        const pluginLogs = new _ElectronForgeLogging.default(tab);
        const config = await this.configGenerator.getRendererConfig(this.config.renderer.entryPoints);
        if (!config.plugins) config.plugins = [];
        config.plugins.push(pluginLogs);
        const compiler = (0, _webpack.default)(config);
        const webpackDevServer = new _webpackDevServer.default(compiler, {
          hot: true,
          port: this.port,
          static: _path.default.resolve(this.baseDir, 'renderer'),
          devMiddleware: {
            writeToDisk: true
          },
          setupExitSignals: true,
          historyApiFallback: true
        });
        const server = await webpackDevServer.listen(this.port);
        this.servers.push(server);
      });
      await (0, _asyncOra.asyncOra)('Compiling Preload Scripts', async () => {
        for (const entryPoint of this.config.renderer.entryPoints) {
          if (entryPoint.preload) {
            const config = await this.configGenerator.getPreloadRendererConfig(entryPoint, entryPoint.preload);
            await new Promise((resolve, reject) => {
              const tab = logger.createTab(`${entryPoint.name} - Preload`);
              const [onceResolve, onceReject] = (0, _once.default)(resolve, reject);
              this.watchers.push((0, _webpack.default)(config).watch({}, (err, stats) => {
                if (stats) {
                  tab.log(stats.toString({
                    colors: true
                  }));
                }

                if (err) return onceReject(err);
                return onceResolve(undefined);
              }));
            });
          }
        }
      });
    });

    _defineProperty(this, "alreadyStarted", false);

    if (c.port) {
      if (this.isValidPort(c.port)) {
        this.port = c.port;
      }
    }

    if (c.loggerPort) {
      if (this.isValidPort(c.loggerPort)) {
        this.loggerPort = c.loggerPort;
      }
    }

    this.startLogic = this.startLogic.bind(this);
    this.getHook = this.getHook.bind(this);
  }

  async writeJSONStats(type, stats, statsOptions) {
    if (!stats) return;
    d(`Writing JSON stats for ${type} config`);
    const jsonStats = stats.toJson(statsOptions);

    const jsonStatsFilename = _path.default.resolve(this.baseDir, type, 'stats.json');

    await _fsExtra.default.writeJson(jsonStatsFilename, jsonStats, {
      spaces: 2
    });
  } // eslint-disable-next-line max-len


  get configGenerator() {
    // eslint-disable-next-line no-underscore-dangle
    if (!this._configGenerator) {
      // eslint-disable-next-line no-underscore-dangle
      this._configGenerator = new _WebpackConfig.default(this.config, this.projectDir, this.isProd, this.port);
    } // eslint-disable-next-line no-underscore-dangle


    return this._configGenerator;
  }

  getHook(name) {
    switch (name) {
      case 'prePackage':
        this.isProd = true;
        return async () => {
          await _fsExtra.default.remove(this.baseDir);
          await this.compileMain();
          await this.compileRenderers();
        };

      case 'postStart':
        return async (_, child) => {
          if (!this.loggedOutputUrl) {
            console.info(`\n\nWebpack Output Available: ${`http://localhost:${this.loggerPort}`.cyan}\n`);
            this.loggedOutputUrl = true;
          }

          d('hooking electron process exit');
          child.on('exit', () => {
            if (child.restarted) return;
            this.exitHandler({
              cleanup: true,
              exit: true
            });
          });
        };

      case 'resolveForgeConfig':
        return this.resolveForgeConfig;

      case 'packageAfterCopy':
        return this.packageAfterCopy;

      default:
        return null;
    }
  }

  async startLogic() {
    if (this.alreadyStarted) return false;
    this.alreadyStarted = true;
    await _fsExtra.default.remove(this.baseDir);
    const logger = new _webMultiLogger.default(this.loggerPort);
    this.loggers.push(logger);
    await this.compileMain(true, logger);
    await this.launchDevServers(logger);
    await logger.start();
    return false;
  }

}

exports.default = WebpackPlugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9XZWJwYWNrUGx1Z2luLnRzIl0sIm5hbWVzIjpbImQiLCJERUZBVUxUX1BPUlQiLCJERUZBVUxUX0xPR0dFUl9QT1JUIiwiV2VicGFja1BsdWdpbiIsIlBsdWdpbkJhc2UiLCJjb25zdHJ1Y3RvciIsImMiLCJwb3J0IiwiRXJyb3IiLCJvcHRpb25zIiwiZXJyIiwiY2xlYW51cCIsIndhdGNoZXIiLCJ3YXRjaGVycyIsImNsb3NlIiwic2VydmVyIiwic2VydmVycyIsImxvZ2dlciIsImxvZ2dlcnMiLCJzdG9wIiwiY29uc29sZSIsImVycm9yIiwic3RhY2siLCJleGl0IiwicHJvY2VzcyIsImlzUmVuZGVyZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInJ1biIsInN0YXRzIiwiY29uZmlnIiwicmVuZGVyZXIiLCJqc29uU3RhdHMiLCJ3cml0ZUpTT05TdGF0cyIsImRpciIsInNldERpcmVjdG9yaWVzIiwib24iLCJfY29kZSIsImV4aXRIYW5kbGVyIiwiX3NpZ25hbCIsInByb2plY3REaXIiLCJiYXNlRGlyIiwicGF0aCIsImZvcmdlQ29uZmlnIiwicGFja2FnZXJDb25maWciLCJpZ25vcmUiLCJyZWQiLCJmaWxlIiwiZW5kc1dpdGgiLCJqb2luIiwidGVzdCIsIl8iLCJidWlsZFBhdGgiLCJwaiIsImZzIiwicmVhZEpzb24iLCJmb3JnZSIsImRldkRlcGVuZGVuY2llcyIsImRlcGVuZGVuY2llcyIsIm9wdGlvbmFsRGVwZW5kZW5jaWVzIiwicGVlckRlcGVuZGVuY2llcyIsIndyaXRlSnNvbiIsInNwYWNlcyIsIm1rZGlycCIsIndhdGNoIiwidGFiIiwiY3JlYXRlVGFiIiwibWFpbkNvbmZpZyIsImNvbmZpZ0dlbmVyYXRvciIsImdldE1haW5Db25maWciLCJjb21waWxlciIsIm9uY2VSZXNvbHZlIiwib25jZVJlamVjdCIsImNiIiwibG9nIiwidG9TdHJpbmciLCJjb2xvcnMiLCJoYXNFcnJvcnMiLCJ1bmRlZmluZWQiLCJwdXNoIiwicnVuV2VicGFjayIsImdldFJlbmRlcmVyQ29uZmlnIiwiZW50cnlQb2ludHMiLCJlbnRyeVBvaW50IiwicHJlbG9hZCIsIm5hbWUiLCJnZXRQcmVsb2FkUmVuZGVyZXJDb25maWciLCJwbHVnaW5Mb2dzIiwiRWxlY3Ryb25Gb3JnZUxvZ2dpbmdQbHVnaW4iLCJwbHVnaW5zIiwid2VicGFja0RldlNlcnZlciIsIldlYnBhY2tEZXZTZXJ2ZXIiLCJob3QiLCJzdGF0aWMiLCJkZXZNaWRkbGV3YXJlIiwid3JpdGVUb0Rpc2siLCJzZXR1cEV4aXRTaWduYWxzIiwiaGlzdG9yeUFwaUZhbGxiYWNrIiwibGlzdGVuIiwiaXNWYWxpZFBvcnQiLCJsb2dnZXJQb3J0Iiwic3RhcnRMb2dpYyIsImJpbmQiLCJnZXRIb29rIiwidHlwZSIsInN0YXRzT3B0aW9ucyIsInRvSnNvbiIsImpzb25TdGF0c0ZpbGVuYW1lIiwiX2NvbmZpZ0dlbmVyYXRvciIsIldlYnBhY2tDb25maWdHZW5lcmF0b3IiLCJpc1Byb2QiLCJyZW1vdmUiLCJjb21waWxlTWFpbiIsImNvbXBpbGVSZW5kZXJlcnMiLCJjaGlsZCIsImxvZ2dlZE91dHB1dFVybCIsImluZm8iLCJjeWFuIiwicmVzdGFydGVkIiwicmVzb2x2ZUZvcmdlQ29uZmlnIiwicGFja2FnZUFmdGVyQ29weSIsImFscmVhZHlTdGFydGVkIiwiTG9nZ2VyIiwibGF1bmNoRGV2U2VydmVycyIsInN0YXJ0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHLG9CQUFNLCtCQUFOLENBQVY7QUFDQSxNQUFNQyxZQUFZLEdBQUcsSUFBckI7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyxJQUE1Qjs7QUFLZSxNQUFNQyxhQUFOLFNBQTRCQyxtQkFBNUIsQ0FBNEQ7QUFxQnpFQyxFQUFBQSxXQUFXLENBQUNDLENBQUQsRUFBeUI7QUFDbEMsVUFBTUEsQ0FBTjs7QUFEa0Msa0NBcEI3QixTQW9CNkI7O0FBQUEsb0NBbEJuQixLQWtCbUI7O0FBQUE7O0FBQUE7O0FBQUE7O0FBQUEsc0NBVkwsRUFVSzs7QUFBQSxxQ0FSSCxFQVFHOztBQUFBLHFDQU5SLEVBTVE7O0FBQUEsa0NBSnJCTCxZQUlxQjs7QUFBQSx3Q0FGZkMsbUJBRWU7O0FBQUEseUNBa0JiSyxJQUFELElBQWtCO0FBQ3RDLFVBQUlBLElBQUksR0FBRyxJQUFYLEVBQWlCO0FBQ2YsY0FBTSxJQUFJQyxLQUFKLENBQVcsd0JBQXVCRCxJQUFLLHNDQUF2QyxDQUFOO0FBQ0QsT0FGRCxNQUVPLElBQUlBLElBQUksR0FBRyxLQUFYLEVBQWtCO0FBQ3ZCLGNBQU0sSUFBSUMsS0FBSixDQUFXLG1CQUFrQkQsSUFBSyw0QkFBbEMsQ0FBTjtBQUNELE9BRk0sTUFFQTtBQUNMLGVBQU8sSUFBUDtBQUNEO0FBQ0YsS0ExQm1DOztBQUFBLHlDQTRCdEIsQ0FBQ0UsT0FBRCxFQUFpREMsR0FBakQsS0FBaUU7QUFDN0VWLE1BQUFBLENBQUMsQ0FBQyw2QkFBRCxFQUFnQ1MsT0FBaEMsQ0FBRDs7QUFDQSxVQUFJQSxPQUFPLENBQUNFLE9BQVosRUFBcUI7QUFDbkIsYUFBSyxNQUFNQyxPQUFYLElBQXNCLEtBQUtDLFFBQTNCLEVBQXFDO0FBQ25DYixVQUFBQSxDQUFDLENBQUMsMEJBQUQsQ0FBRDtBQUNBWSxVQUFBQSxPQUFPLENBQUNFLEtBQVIsQ0FBYyxNQUFNLENBQUUsQ0FBdEI7QUFDRDs7QUFDRCxhQUFLRCxRQUFMLEdBQWdCLEVBQWhCOztBQUNBLGFBQUssTUFBTUUsTUFBWCxJQUFxQixLQUFLQyxPQUExQixFQUFtQztBQUNqQ2hCLFVBQUFBLENBQUMsQ0FBQyxzQkFBRCxDQUFEO0FBQ0FlLFVBQUFBLE1BQU0sQ0FBQ0QsS0FBUDtBQUNEOztBQUNELGFBQUtFLE9BQUwsR0FBZSxFQUFmOztBQUNBLGFBQUssTUFBTUMsTUFBWCxJQUFxQixLQUFLQyxPQUExQixFQUFtQztBQUNqQ2xCLFVBQUFBLENBQUMsQ0FBQyxpQkFBRCxDQUFEO0FBQ0FpQixVQUFBQSxNQUFNLENBQUNFLElBQVA7QUFDRDs7QUFDRCxhQUFLRCxPQUFMLEdBQWUsRUFBZjtBQUNEOztBQUNELFVBQUlSLEdBQUosRUFBU1UsT0FBTyxDQUFDQyxLQUFSLENBQWNYLEdBQUcsQ0FBQ1ksS0FBbEI7QUFDVCxVQUFJYixPQUFPLENBQUNjLElBQVosRUFBa0JDLE9BQU8sQ0FBQ0QsSUFBUjtBQUNuQixLQWpEbUM7O0FBQUEsd0NBZ0VmLE9BQU9kLE9BQVAsRUFBK0JnQixVQUFVLEdBQUcsS0FBNUMsS0FBMEYsSUFBSUMsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUM5SSw0QkFBUW5CLE9BQVIsRUFDR29CLEdBREgsQ0FDTyxPQUFPbkIsR0FBUCxFQUFZb0IsS0FBWixLQUFzQjtBQUN6QixZQUFJTCxVQUFVLElBQUksS0FBS00sTUFBTCxDQUFZQyxRQUFaLENBQXFCQyxTQUF2QyxFQUFrRDtBQUNoRCxnQkFBTSxLQUFLQyxjQUFMLENBQW9CLFVBQXBCLEVBQWdDSixLQUFoQyxFQUF1Q3JCLE9BQU8sQ0FBQ3FCLEtBQS9DLENBQU47QUFDRDs7QUFDRCxZQUFJcEIsR0FBSixFQUFTO0FBQ1AsaUJBQU9rQixNQUFNLENBQUNsQixHQUFELENBQWI7QUFDRDs7QUFDRCxlQUFPaUIsT0FBTyxDQUFDRyxLQUFELENBQWQ7QUFDRCxPQVRIO0FBVUQsS0FYOEcsQ0FoRTNFOztBQUFBLGtDQTZFNUJLLEdBQUQsSUFBaUI7QUFDdEIsV0FBS0MsY0FBTCxDQUFvQkQsR0FBcEI7QUFFQW5DLE1BQUFBLENBQUMsQ0FBQyx3QkFBRCxDQUFEO0FBQ0F3QixNQUFBQSxPQUFPLENBQUNhLEVBQVIsQ0FBVyxNQUFYLEVBQW9CQyxLQUFELElBQVcsS0FBS0MsV0FBTCxDQUFpQjtBQUFFNUIsUUFBQUEsT0FBTyxFQUFFO0FBQVgsT0FBakIsQ0FBOUI7QUFDQWEsTUFBQUEsT0FBTyxDQUFDYSxFQUFSLENBQVcsUUFBWCxFQUF3Q0csT0FBRCxJQUFhLEtBQUtELFdBQUwsQ0FBaUI7QUFBRWhCLFFBQUFBLElBQUksRUFBRTtBQUFSLE9BQWpCLENBQXBEO0FBQ0QsS0FuRm1DOztBQUFBLDRDQXFGbEJZLEdBQUQsSUFBaUI7QUFDaEMsV0FBS00sVUFBTCxHQUFrQk4sR0FBbEI7QUFDQSxXQUFLTyxPQUFMLEdBQWVDLGNBQUtoQixPQUFMLENBQWFRLEdBQWIsRUFBa0IsVUFBbEIsQ0FBZjtBQUNELEtBeEZtQzs7QUFBQSw2Q0EwR1YsS0ExR1U7O0FBQUEsZ0RBMElmLE1BQU9TLFdBQVAsSUFBb0M7QUFDdkQsVUFBSSxDQUFDQSxXQUFXLENBQUNDLGNBQWpCLEVBQWlDO0FBQy9CRCxRQUFBQSxXQUFXLENBQUNDLGNBQVosR0FBNkIsRUFBN0I7QUFDRDs7QUFDRCxVQUFJRCxXQUFXLENBQUNDLGNBQVosQ0FBMkJDLE1BQS9CLEVBQXVDO0FBQ3JDMUIsUUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWU7QUFDckI7QUFDQSw2R0FGb0IsQ0FFMEYwQixHQUZ4RztBQUdBLGVBQU9ILFdBQVA7QUFDRDs7QUFDREEsTUFBQUEsV0FBVyxDQUFDQyxjQUFaLENBQTJCQyxNQUEzQixHQUFxQ0UsSUFBRCxJQUFrQjtBQUNwRCxZQUFJLENBQUNBLElBQUwsRUFBVyxPQUFPLEtBQVA7O0FBRVgsWUFBSSxLQUFLakIsTUFBTCxDQUFZRSxTQUFaLElBQXlCZSxJQUFJLENBQUNDLFFBQUwsQ0FBY04sY0FBS08sSUFBTCxDQUFVLFVBQVYsRUFBc0IsTUFBdEIsRUFBOEIsWUFBOUIsQ0FBZCxDQUE3QixFQUF5RjtBQUN2RixpQkFBTyxJQUFQO0FBQ0Q7O0FBRUQsWUFBSSxLQUFLbkIsTUFBTCxDQUFZQyxRQUFaLENBQXFCQyxTQUFyQixJQUFrQ2UsSUFBSSxDQUFDQyxRQUFMLENBQWNOLGNBQUtPLElBQUwsQ0FBVSxVQUFWLEVBQXNCLFVBQXRCLEVBQWtDLFlBQWxDLENBQWQsQ0FBdEMsRUFBc0c7QUFDcEcsaUJBQU8sSUFBUDtBQUNEOztBQUVELGVBQU8sQ0FBQyw4QkFBOEJDLElBQTlCLENBQW1DSCxJQUFuQyxDQUFSO0FBQ0QsT0FaRDs7QUFhQSxhQUFPSixXQUFQO0FBQ0QsS0FsS21DOztBQUFBLDhDQW9LakIsT0FBT1EsQ0FBUCxFQUFlQyxTQUFmLEtBQXFDO0FBQ3RELFlBQU1DLEVBQUUsR0FBRyxNQUFNQyxpQkFBR0MsUUFBSCxDQUFZYixjQUFLaEIsT0FBTCxDQUFhLEtBQUtjLFVBQWxCLEVBQThCLGNBQTlCLENBQVosQ0FBakI7O0FBQ0EsVUFBSWEsRUFBRSxDQUFDdkIsTUFBUCxFQUFlO0FBQ2IsZUFBT3VCLEVBQUUsQ0FBQ3ZCLE1BQUgsQ0FBVTBCLEtBQWpCO0FBQ0Q7O0FBQ0RILE1BQUFBLEVBQUUsQ0FBQ0ksZUFBSCxHQUFxQixFQUFyQjtBQUNBSixNQUFBQSxFQUFFLENBQUNLLFlBQUgsR0FBa0IsRUFBbEI7QUFDQUwsTUFBQUEsRUFBRSxDQUFDTSxvQkFBSCxHQUEwQixFQUExQjtBQUNBTixNQUFBQSxFQUFFLENBQUNPLGdCQUFILEdBQXNCLEVBQXRCO0FBRUEsWUFBTU4saUJBQUdPLFNBQUgsQ0FDSm5CLGNBQUtoQixPQUFMLENBQWEwQixTQUFiLEVBQXdCLGNBQXhCLENBREksRUFFSkMsRUFGSSxFQUdKO0FBQ0VTLFFBQUFBLE1BQU0sRUFBRTtBQURWLE9BSEksQ0FBTjtBQVFBLFlBQU1SLGlCQUFHUyxNQUFILENBQVVyQixjQUFLaEIsT0FBTCxDQUFhMEIsU0FBYixFQUF3QixjQUF4QixDQUFWLENBQU47QUFDRCxLQXZMbUM7O0FBQUEseUNBeUx0QixPQUFPWSxLQUFLLEdBQUcsS0FBZixFQUFzQmhELE1BQXRCLEtBQTBDO0FBQ3RELFVBQUlpRCxHQUFKOztBQUNBLFVBQUlqRCxNQUFKLEVBQVk7QUFDVmlELFFBQUFBLEdBQUcsR0FBR2pELE1BQU0sQ0FBQ2tELFNBQVAsQ0FBaUIsY0FBakIsQ0FBTjtBQUNEOztBQUNELFlBQU0sd0JBQVMsNkJBQVQsRUFBd0MsWUFBWTtBQUN4RCxjQUFNQyxVQUFVLEdBQUcsTUFBTSxLQUFLQyxlQUFMLENBQXFCQyxhQUFyQixFQUF6QjtBQUNBLGNBQU0sSUFBSTVDLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDckMsZ0JBQU0yQyxRQUFRLEdBQUcsc0JBQVFILFVBQVIsQ0FBakI7QUFDQSxnQkFBTSxDQUFDSSxXQUFELEVBQWNDLFVBQWQsSUFBNEIsbUJBQUs5QyxPQUFMLEVBQWNDLE1BQWQsQ0FBbEM7O0FBQ0EsZ0JBQU04QyxFQUF1QixHQUFHLE9BQU9oRSxHQUFQLEVBQVlvQixLQUFaLEtBQXNCO0FBQ3BELGdCQUFJb0MsR0FBRyxJQUFJcEMsS0FBWCxFQUFrQjtBQUNoQm9DLGNBQUFBLEdBQUcsQ0FBQ1MsR0FBSixDQUFRN0MsS0FBSyxDQUFDOEMsUUFBTixDQUFlO0FBQ3JCQyxnQkFBQUEsTUFBTSxFQUFFO0FBRGEsZUFBZixDQUFSO0FBR0Q7O0FBQ0QsZ0JBQUksS0FBSzlDLE1BQUwsQ0FBWUUsU0FBaEIsRUFBMkI7QUFDekIsb0JBQU0sS0FBS0MsY0FBTCxDQUFvQixNQUFwQixFQUE0QkosS0FBNUIsRUFBbUNzQyxVQUFVLENBQUN0QyxLQUE5QyxDQUFOO0FBQ0Q7O0FBRUQsZ0JBQUlwQixHQUFKLEVBQVMsT0FBTytELFVBQVUsQ0FBQy9ELEdBQUQsQ0FBakI7O0FBQ1QsZ0JBQUksQ0FBQ3VELEtBQUQsSUFBVW5DLEtBQVYsYUFBVUEsS0FBVixlQUFVQSxLQUFLLENBQUVnRCxTQUFQLEVBQWQsRUFBa0M7QUFDaEMscUJBQU9MLFVBQVUsQ0FBQyxJQUFJakUsS0FBSixDQUFXLDJDQUEwQ3NCLEtBQUssQ0FBQzhDLFFBQU4sRUFBaUIsRUFBdEUsQ0FBRCxDQUFqQjtBQUNEOztBQUVELG1CQUFPSixXQUFXLENBQUNPLFNBQUQsQ0FBbEI7QUFDRCxXQWhCRDs7QUFpQkEsY0FBSWQsS0FBSixFQUFXO0FBQ1QsaUJBQUtwRCxRQUFMLENBQWNtRSxJQUFkLENBQW1CVCxRQUFRLENBQUNOLEtBQVQsQ0FBZSxFQUFmLEVBQW1CUyxFQUFuQixDQUFuQjtBQUNELFdBRkQsTUFFTztBQUNMSCxZQUFBQSxRQUFRLENBQUMxQyxHQUFULENBQWE2QyxFQUFiO0FBQ0Q7QUFDRixTQXpCSyxDQUFOO0FBMEJELE9BNUJLLENBQU47QUE2QkQsS0EzTm1DOztBQUFBLDhDQTZOakIsT0FBT1QsS0FBSyxHQUFHLEtBQWYsS0FBeUI7QUFDMUMsWUFBTSx3QkFBUyw2QkFBVCxFQUF3QyxZQUFZO0FBQ3hELGNBQU1uQyxLQUFLLEdBQUcsTUFBTSxLQUFLbUQsVUFBTCxDQUNsQixNQUFNLEtBQUtaLGVBQUwsQ0FBcUJhLGlCQUFyQixDQUF1QyxLQUFLbkQsTUFBTCxDQUFZQyxRQUFaLENBQXFCbUQsV0FBNUQsQ0FEWSxFQUVsQixJQUZrQixDQUFwQjs7QUFJQSxZQUFJLENBQUNsQixLQUFELElBQVVuQyxLQUFWLGFBQVVBLEtBQVYsZUFBVUEsS0FBSyxDQUFFZ0QsU0FBUCxFQUFkLEVBQWtDO0FBQ2hDLGdCQUFNLElBQUl0RSxLQUFKLENBQVcsdUNBQXNDc0IsS0FBSyxDQUFDOEMsUUFBTixFQUFpQixFQUFsRSxDQUFOO0FBQ0Q7QUFDRixPQVJLLENBQU47O0FBVUEsV0FBSyxNQUFNUSxVQUFYLElBQXlCLEtBQUtyRCxNQUFMLENBQVlDLFFBQVosQ0FBcUJtRCxXQUE5QyxFQUEyRDtBQUN6RCxZQUFJQyxVQUFVLENBQUNDLE9BQWYsRUFBd0I7QUFDdEIsZ0JBQU0sd0JBQVUsK0JBQThCRCxVQUFVLENBQUNFLElBQUssRUFBeEQsRUFBMkQsWUFBWTtBQUMzRSxrQkFBTSxLQUFLTCxVQUFMLENBQ0osTUFBTSxLQUFLWixlQUFMLENBQXFCa0Isd0JBQXJCLENBQThDSCxVQUE5QyxFQUEwREEsVUFBVSxDQUFDQyxPQUFyRSxDQURGLENBQU47QUFHRCxXQUpLLENBQU47QUFLRDtBQUNGO0FBQ0YsS0FqUG1DOztBQUFBLDhDQW1QakIsTUFBT3BFLE1BQVAsSUFBMEI7QUFDM0MsWUFBTSx3QkFBUyxvQkFBVCxFQUErQixZQUFZO0FBQy9DLGNBQU1pRCxHQUFHLEdBQUdqRCxNQUFNLENBQUNrRCxTQUFQLENBQWlCLFdBQWpCLENBQVo7QUFDQSxjQUFNcUIsVUFBVSxHQUFHLElBQUlDLDZCQUFKLENBQStCdkIsR0FBL0IsQ0FBbkI7QUFFQSxjQUFNbkMsTUFBTSxHQUFHLE1BQU0sS0FBS3NDLGVBQUwsQ0FBcUJhLGlCQUFyQixDQUF1QyxLQUFLbkQsTUFBTCxDQUFZQyxRQUFaLENBQXFCbUQsV0FBNUQsQ0FBckI7QUFDQSxZQUFJLENBQUNwRCxNQUFNLENBQUMyRCxPQUFaLEVBQXFCM0QsTUFBTSxDQUFDMkQsT0FBUCxHQUFpQixFQUFqQjtBQUNyQjNELFFBQUFBLE1BQU0sQ0FBQzJELE9BQVAsQ0FBZVYsSUFBZixDQUFvQlEsVUFBcEI7QUFDQSxjQUFNakIsUUFBUSxHQUFHLHNCQUFReEMsTUFBUixDQUFqQjtBQUNBLGNBQU00RCxnQkFBZ0IsR0FBRyxJQUFJQyx5QkFBSixDQUFxQnJCLFFBQXJCLEVBQStCO0FBQ3REc0IsVUFBQUEsR0FBRyxFQUFFLElBRGlEO0FBRXREdEYsVUFBQUEsSUFBSSxFQUFFLEtBQUtBLElBRjJDO0FBR3REdUYsVUFBQUEsTUFBTSxFQUFFbkQsY0FBS2hCLE9BQUwsQ0FBYSxLQUFLZSxPQUFsQixFQUEyQixVQUEzQixDQUg4QztBQUl0RHFELFVBQUFBLGFBQWEsRUFBRTtBQUNiQyxZQUFBQSxXQUFXLEVBQUU7QUFEQSxXQUp1QztBQU90REMsVUFBQUEsZ0JBQWdCLEVBQUUsSUFQb0M7QUFRdERDLFVBQUFBLGtCQUFrQixFQUFFO0FBUmtDLFNBQS9CLENBQXpCO0FBVUEsY0FBTW5GLE1BQU0sR0FBRyxNQUFNNEUsZ0JBQWdCLENBQUNRLE1BQWpCLENBQXdCLEtBQUs1RixJQUE3QixDQUFyQjtBQUNBLGFBQUtTLE9BQUwsQ0FBYWdFLElBQWIsQ0FBa0JqRSxNQUFsQjtBQUNELE9BcEJLLENBQU47QUFzQkEsWUFBTSx3QkFBUywyQkFBVCxFQUFzQyxZQUFZO0FBQ3RELGFBQUssTUFBTXFFLFVBQVgsSUFBeUIsS0FBS3JELE1BQUwsQ0FBWUMsUUFBWixDQUFxQm1ELFdBQTlDLEVBQTJEO0FBQ3pELGNBQUlDLFVBQVUsQ0FBQ0MsT0FBZixFQUF3QjtBQUN0QixrQkFBTXRELE1BQU0sR0FBRyxNQUFNLEtBQUtzQyxlQUFMLENBQXFCa0Isd0JBQXJCLENBQ25CSCxVQURtQixFQUVuQkEsVUFBVSxDQUFDQyxPQUZRLENBQXJCO0FBSUEsa0JBQU0sSUFBSTNELE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDckMsb0JBQU1zQyxHQUFHLEdBQUdqRCxNQUFNLENBQUNrRCxTQUFQLENBQWtCLEdBQUVpQixVQUFVLENBQUNFLElBQUssWUFBcEMsQ0FBWjtBQUNBLG9CQUFNLENBQUNkLFdBQUQsRUFBY0MsVUFBZCxJQUE0QixtQkFBSzlDLE9BQUwsRUFBY0MsTUFBZCxDQUFsQztBQUVBLG1CQUFLZixRQUFMLENBQWNtRSxJQUFkLENBQW1CLHNCQUFRakQsTUFBUixFQUFnQmtDLEtBQWhCLENBQXNCLEVBQXRCLEVBQTBCLENBQUN2RCxHQUFELEVBQU1vQixLQUFOLEtBQWdCO0FBQzNELG9CQUFJQSxLQUFKLEVBQVc7QUFDVG9DLGtCQUFBQSxHQUFHLENBQUNTLEdBQUosQ0FBUTdDLEtBQUssQ0FBQzhDLFFBQU4sQ0FBZTtBQUNyQkMsb0JBQUFBLE1BQU0sRUFBRTtBQURhLG1CQUFmLENBQVI7QUFHRDs7QUFFRCxvQkFBSW5FLEdBQUosRUFBUyxPQUFPK0QsVUFBVSxDQUFDL0QsR0FBRCxDQUFqQjtBQUNULHVCQUFPOEQsV0FBVyxDQUFDTyxTQUFELENBQWxCO0FBQ0QsZUFUa0IsQ0FBbkI7QUFVRCxhQWRLLENBQU47QUFlRDtBQUNGO0FBQ0YsT0F4QkssQ0FBTjtBQXlCRCxLQW5TbUM7O0FBQUEsNENBcVNYLEtBclNXOztBQUdsQyxRQUFJekUsQ0FBQyxDQUFDQyxJQUFOLEVBQVk7QUFDVixVQUFJLEtBQUs2RixXQUFMLENBQWlCOUYsQ0FBQyxDQUFDQyxJQUFuQixDQUFKLEVBQThCO0FBQzVCLGFBQUtBLElBQUwsR0FBWUQsQ0FBQyxDQUFDQyxJQUFkO0FBQ0Q7QUFDRjs7QUFDRCxRQUFJRCxDQUFDLENBQUMrRixVQUFOLEVBQWtCO0FBQ2hCLFVBQUksS0FBS0QsV0FBTCxDQUFpQjlGLENBQUMsQ0FBQytGLFVBQW5CLENBQUosRUFBb0M7QUFDbEMsYUFBS0EsVUFBTCxHQUFrQi9GLENBQUMsQ0FBQytGLFVBQXBCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFLQyxVQUFMLEdBQWtCLEtBQUtBLFVBQUwsQ0FBZ0JDLElBQWhCLENBQXFCLElBQXJCLENBQWxCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlLEtBQUtBLE9BQUwsQ0FBYUQsSUFBYixDQUFrQixJQUFsQixDQUFmO0FBQ0Q7O0FBbUNtQixRQUFkckUsY0FBYyxDQUNsQnVFLElBRGtCLEVBRWxCM0UsS0FGa0IsRUFHbEI0RSxZQUhrQixFQUlIO0FBQ2YsUUFBSSxDQUFDNUUsS0FBTCxFQUFZO0FBQ1o5QixJQUFBQSxDQUFDLENBQUUsMEJBQXlCeUcsSUFBSyxTQUFoQyxDQUFEO0FBQ0EsVUFBTXhFLFNBQVMsR0FBR0gsS0FBSyxDQUFDNkUsTUFBTixDQUFhRCxZQUFiLENBQWxCOztBQUNBLFVBQU1FLGlCQUFpQixHQUFHakUsY0FBS2hCLE9BQUwsQ0FBYSxLQUFLZSxPQUFsQixFQUEyQitELElBQTNCLEVBQWlDLFlBQWpDLENBQTFCOztBQUNBLFVBQU1sRCxpQkFBR08sU0FBSCxDQUFhOEMsaUJBQWIsRUFBZ0MzRSxTQUFoQyxFQUEyQztBQUFFOEIsTUFBQUEsTUFBTSxFQUFFO0FBQVYsS0FBM0MsQ0FBTjtBQUNELEdBbEZ3RSxDQW9GekU7OztBQTJCbUIsTUFBZk0sZUFBZSxHQUFHO0FBQ3BCO0FBQ0EsUUFBSSxDQUFDLEtBQUt3QyxnQkFBVixFQUE0QjtBQUMxQjtBQUNBLFdBQUtBLGdCQUFMLEdBQXdCLElBQUlDLHNCQUFKLENBQ3RCLEtBQUsvRSxNQURpQixFQUV0QixLQUFLVSxVQUZpQixFQUd0QixLQUFLc0UsTUFIaUIsRUFJdEIsS0FBS3hHLElBSmlCLENBQXhCO0FBTUQsS0FWbUIsQ0FZcEI7OztBQUNBLFdBQU8sS0FBS3NHLGdCQUFaO0FBQ0Q7O0FBSURMLEVBQUFBLE9BQU8sQ0FBQ2xCLElBQUQsRUFBZTtBQUNwQixZQUFRQSxJQUFSO0FBQ0UsV0FBSyxZQUFMO0FBQ0UsYUFBS3lCLE1BQUwsR0FBYyxJQUFkO0FBQ0EsZUFBTyxZQUFZO0FBQ2pCLGdCQUFNeEQsaUJBQUd5RCxNQUFILENBQVUsS0FBS3RFLE9BQWYsQ0FBTjtBQUNBLGdCQUFNLEtBQUt1RSxXQUFMLEVBQU47QUFDQSxnQkFBTSxLQUFLQyxnQkFBTCxFQUFOO0FBQ0QsU0FKRDs7QUFLRixXQUFLLFdBQUw7QUFDRSxlQUFPLE9BQU85RCxDQUFQLEVBQWUrRCxLQUFmLEtBQTBDO0FBQy9DLGNBQUksQ0FBQyxLQUFLQyxlQUFWLEVBQTJCO0FBQ3pCaEcsWUFBQUEsT0FBTyxDQUFDaUcsSUFBUixDQUFjLGlDQUFrQyxvQkFBbUIsS0FBS2hCLFVBQVcsRUFBckMsQ0FBd0NpQixJQUFLLElBQTNGO0FBQ0EsaUJBQUtGLGVBQUwsR0FBdUIsSUFBdkI7QUFDRDs7QUFDRHBILFVBQUFBLENBQUMsQ0FBQywrQkFBRCxDQUFEO0FBQ0FtSCxVQUFBQSxLQUFLLENBQUM5RSxFQUFOLENBQVMsTUFBVCxFQUFpQixNQUFNO0FBQ3JCLGdCQUFJOEUsS0FBSyxDQUFDSSxTQUFWLEVBQXFCO0FBQ3JCLGlCQUFLaEYsV0FBTCxDQUFpQjtBQUFFNUIsY0FBQUEsT0FBTyxFQUFFLElBQVg7QUFBaUJZLGNBQUFBLElBQUksRUFBRTtBQUF2QixhQUFqQjtBQUNELFdBSEQ7QUFJRCxTQVZEOztBQVdGLFdBQUssb0JBQUw7QUFDRSxlQUFPLEtBQUtpRyxrQkFBWjs7QUFDRixXQUFLLGtCQUFMO0FBQ0UsZUFBTyxLQUFLQyxnQkFBWjs7QUFDRjtBQUNFLGVBQU8sSUFBUDtBQXpCSjtBQTJCRDs7QUErSmUsUUFBVm5CLFVBQVUsR0FBbUI7QUFDakMsUUFBSSxLQUFLb0IsY0FBVCxFQUF5QixPQUFPLEtBQVA7QUFDekIsU0FBS0EsY0FBTCxHQUFzQixJQUF0QjtBQUVBLFVBQU1uRSxpQkFBR3lELE1BQUgsQ0FBVSxLQUFLdEUsT0FBZixDQUFOO0FBRUEsVUFBTXpCLE1BQU0sR0FBRyxJQUFJMEcsdUJBQUosQ0FBVyxLQUFLdEIsVUFBaEIsQ0FBZjtBQUNBLFNBQUtuRixPQUFMLENBQWE4RCxJQUFiLENBQWtCL0QsTUFBbEI7QUFDQSxVQUFNLEtBQUtnRyxXQUFMLENBQWlCLElBQWpCLEVBQXVCaEcsTUFBdkIsQ0FBTjtBQUNBLFVBQU0sS0FBSzJHLGdCQUFMLENBQXNCM0csTUFBdEIsQ0FBTjtBQUNBLFVBQU1BLE1BQU0sQ0FBQzRHLEtBQVAsRUFBTjtBQUNBLFdBQU8sS0FBUDtBQUNEOztBQXhVd0UiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQgXCJuby1jb25zb2xlXCI6IFwib2ZmXCIgKi9cbmltcG9ydCB7IGFzeW5jT3JhIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2FzeW5jLW9yYSc7XG5pbXBvcnQgUGx1Z2luQmFzZSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvcGx1Z2luLWJhc2UnO1xuaW1wb3J0IHsgRWxlY3Ryb25Qcm9jZXNzLCBGb3JnZUNvbmZpZyB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9zaGFyZWQtdHlwZXMnO1xuaW1wb3J0IExvZ2dlciwgeyBUYWIgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvd2ViLW11bHRpLWxvZ2dlcic7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgd2VicGFjaywgeyBDb25maWd1cmF0aW9uLCBXYXRjaGluZyB9IGZyb20gJ3dlYnBhY2snO1xuaW1wb3J0IFdlYnBhY2tEZXZTZXJ2ZXIgZnJvbSAnd2VicGFjay1kZXYtc2VydmVyJztcbmltcG9ydCB7IFdlYnBhY2tQbHVnaW5Db25maWcgfSBmcm9tICcuL0NvbmZpZyc7XG5pbXBvcnQgRWxlY3Ryb25Gb3JnZUxvZ2dpbmdQbHVnaW4gZnJvbSAnLi91dGlsL0VsZWN0cm9uRm9yZ2VMb2dnaW5nJztcbmltcG9ydCBvbmNlIGZyb20gJy4vdXRpbC9vbmNlJztcbmltcG9ydCBXZWJwYWNrQ29uZmlnR2VuZXJhdG9yIGZyb20gJy4vV2VicGFja0NvbmZpZyc7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6cGx1Z2luOndlYnBhY2snKTtcbmNvbnN0IERFRkFVTFRfUE9SVCA9IDMwMDA7XG5jb25zdCBERUZBVUxUX0xPR0dFUl9QT1JUID0gOTAwMDtcblxudHlwZSBXZWJwYWNrVG9Kc29uT3B0aW9ucyA9IFBhcmFtZXRlcnM8d2VicGFjay5TdGF0c1sndG9Kc29uJ10+WzBdO1xudHlwZSBXZWJwYWNrV2F0Y2hIYW5kbGVyID0gUGFyYW1ldGVyczx3ZWJwYWNrLkNvbXBpbGVyWyd3YXRjaCddPlsxXTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2VicGFja1BsdWdpbiBleHRlbmRzIFBsdWdpbkJhc2U8V2VicGFja1BsdWdpbkNvbmZpZz4ge1xuICBuYW1lID0gJ3dlYnBhY2snO1xuXG4gIHByaXZhdGUgaXNQcm9kID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBwcm9qZWN0RGlyITogc3RyaW5nO1xuXG4gIHByaXZhdGUgYmFzZURpciE6IHN0cmluZztcblxuICBwcml2YXRlIF9jb25maWdHZW5lcmF0b3IhOiBXZWJwYWNrQ29uZmlnR2VuZXJhdG9yO1xuXG4gIHByaXZhdGUgd2F0Y2hlcnM6IFdhdGNoaW5nW10gPSBbXTtcblxuICBwcml2YXRlIHNlcnZlcnM6IGh0dHAuU2VydmVyW10gPSBbXTtcblxuICBwcml2YXRlIGxvZ2dlcnM6IExvZ2dlcltdID0gW107XG5cbiAgcHJpdmF0ZSBwb3J0ID0gREVGQVVMVF9QT1JUO1xuXG4gIHByaXZhdGUgbG9nZ2VyUG9ydCA9IERFRkFVTFRfTE9HR0VSX1BPUlQ7XG5cbiAgY29uc3RydWN0b3IoYzogV2VicGFja1BsdWdpbkNvbmZpZykge1xuICAgIHN1cGVyKGMpO1xuXG4gICAgaWYgKGMucG9ydCkge1xuICAgICAgaWYgKHRoaXMuaXNWYWxpZFBvcnQoYy5wb3J0KSkge1xuICAgICAgICB0aGlzLnBvcnQgPSBjLnBvcnQ7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChjLmxvZ2dlclBvcnQpIHtcbiAgICAgIGlmICh0aGlzLmlzVmFsaWRQb3J0KGMubG9nZ2VyUG9ydCkpIHtcbiAgICAgICAgdGhpcy5sb2dnZXJQb3J0ID0gYy5sb2dnZXJQb3J0O1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuc3RhcnRMb2dpYyA9IHRoaXMuc3RhcnRMb2dpYy5iaW5kKHRoaXMpO1xuICAgIHRoaXMuZ2V0SG9vayA9IHRoaXMuZ2V0SG9vay5iaW5kKHRoaXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1ZhbGlkUG9ydCA9IChwb3J0OiBudW1iZXIpID0+IHtcbiAgICBpZiAocG9ydCA8IDEwMjQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHNwZWNpZnkgcG9ydCAoJHtwb3J0fSkgYmVsb3cgMTAyNCwgYXMgdGhleSBhcmUgcHJpdmlsZWdlZGApO1xuICAgIH0gZWxzZSBpZiAocG9ydCA+IDY1NTM1KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFBvcnQgc3BlY2lmaWVkICgke3BvcnR9KSBpcyBub3QgYSB2YWxpZCBUQ1AgcG9ydC5gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgZXhpdEhhbmRsZXIgPSAob3B0aW9uczogeyBjbGVhbnVwPzogYm9vbGVhbjsgZXhpdD86IGJvb2xlYW4gfSwgZXJyPzogRXJyb3IpID0+IHtcbiAgICBkKCdoYW5kbGluZyBwcm9jZXNzIGV4aXQgd2l0aDonLCBvcHRpb25zKTtcbiAgICBpZiAob3B0aW9ucy5jbGVhbnVwKSB7XG4gICAgICBmb3IgKGNvbnN0IHdhdGNoZXIgb2YgdGhpcy53YXRjaGVycykge1xuICAgICAgICBkKCdjbGVhbmluZyB3ZWJwYWNrIHdhdGNoZXInKTtcbiAgICAgICAgd2F0Y2hlci5jbG9zZSgoKSA9PiB7fSk7XG4gICAgICB9XG4gICAgICB0aGlzLndhdGNoZXJzID0gW107XG4gICAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiB0aGlzLnNlcnZlcnMpIHtcbiAgICAgICAgZCgnY2xlYW5pbmcgaHR0cCBzZXJ2ZXInKTtcbiAgICAgICAgc2VydmVyLmNsb3NlKCk7XG4gICAgICB9XG4gICAgICB0aGlzLnNlcnZlcnMgPSBbXTtcbiAgICAgIGZvciAoY29uc3QgbG9nZ2VyIG9mIHRoaXMubG9nZ2Vycykge1xuICAgICAgICBkKCdzdG9wcGluZyBsb2dnZXInKTtcbiAgICAgICAgbG9nZ2VyLnN0b3AoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9nZ2VycyA9IFtdO1xuICAgIH1cbiAgICBpZiAoZXJyKSBjb25zb2xlLmVycm9yKGVyci5zdGFjayk7XG4gICAgaWYgKG9wdGlvbnMuZXhpdCkgcHJvY2Vzcy5leGl0KCk7XG4gIH1cblxuICBhc3luYyB3cml0ZUpTT05TdGF0cyhcbiAgICB0eXBlOiBzdHJpbmcsXG4gICAgc3RhdHM6IHdlYnBhY2suU3RhdHMgfCB1bmRlZmluZWQsXG4gICAgc3RhdHNPcHRpb25zOiBXZWJwYWNrVG9Kc29uT3B0aW9ucyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFzdGF0cykgcmV0dXJuO1xuICAgIGQoYFdyaXRpbmcgSlNPTiBzdGF0cyBmb3IgJHt0eXBlfSBjb25maWdgKTtcbiAgICBjb25zdCBqc29uU3RhdHMgPSBzdGF0cy50b0pzb24oc3RhdHNPcHRpb25zKTtcbiAgICBjb25zdCBqc29uU3RhdHNGaWxlbmFtZSA9IHBhdGgucmVzb2x2ZSh0aGlzLmJhc2VEaXIsIHR5cGUsICdzdGF0cy5qc29uJyk7XG4gICAgYXdhaXQgZnMud3JpdGVKc29uKGpzb25TdGF0c0ZpbGVuYW1lLCBqc29uU3RhdHMsIHsgc3BhY2VzOiAyIH0pO1xuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgcHJpdmF0ZSBydW5XZWJwYWNrID0gYXN5bmMgKG9wdGlvbnM6IENvbmZpZ3VyYXRpb24sIGlzUmVuZGVyZXIgPSBmYWxzZSk6IFByb21pc2U8d2VicGFjay5TdGF0cyB8IHVuZGVmaW5lZD4gPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHdlYnBhY2sob3B0aW9ucylcbiAgICAgIC5ydW4oYXN5bmMgKGVyciwgc3RhdHMpID0+IHtcbiAgICAgICAgaWYgKGlzUmVuZGVyZXIgJiYgdGhpcy5jb25maWcucmVuZGVyZXIuanNvblN0YXRzKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy53cml0ZUpTT05TdGF0cygncmVuZGVyZXInLCBzdGF0cywgb3B0aW9ucy5zdGF0cyBhcyBXZWJwYWNrVG9Kc29uT3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzb2x2ZShzdGF0cyk7XG4gICAgICB9KTtcbiAgfSk7XG5cbiAgaW5pdCA9IChkaXI6IHN0cmluZykgPT4ge1xuICAgIHRoaXMuc2V0RGlyZWN0b3JpZXMoZGlyKTtcblxuICAgIGQoJ2hvb2tpbmcgcHJvY2VzcyBldmVudHMnKTtcbiAgICBwcm9jZXNzLm9uKCdleGl0JywgKF9jb2RlKSA9PiB0aGlzLmV4aXRIYW5kbGVyKHsgY2xlYW51cDogdHJ1ZSB9KSk7XG4gICAgcHJvY2Vzcy5vbignU0lHSU5UJyBhcyBOb2RlSlMuU2lnbmFscywgKF9zaWduYWwpID0+IHRoaXMuZXhpdEhhbmRsZXIoeyBleGl0OiB0cnVlIH0pKTtcbiAgfVxuXG4gIHNldERpcmVjdG9yaWVzID0gKGRpcjogc3RyaW5nKSA9PiB7XG4gICAgdGhpcy5wcm9qZWN0RGlyID0gZGlyO1xuICAgIHRoaXMuYmFzZURpciA9IHBhdGgucmVzb2x2ZShkaXIsICcud2VicGFjaycpO1xuICB9XG5cbiAgZ2V0IGNvbmZpZ0dlbmVyYXRvcigpIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW5kZXJzY29yZS1kYW5nbGVcbiAgICBpZiAoIXRoaXMuX2NvbmZpZ0dlbmVyYXRvcikge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgICB0aGlzLl9jb25maWdHZW5lcmF0b3IgPSBuZXcgV2VicGFja0NvbmZpZ0dlbmVyYXRvcihcbiAgICAgICAgdGhpcy5jb25maWcsXG4gICAgICAgIHRoaXMucHJvamVjdERpcixcbiAgICAgICAgdGhpcy5pc1Byb2QsXG4gICAgICAgIHRoaXMucG9ydCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgcmV0dXJuIHRoaXMuX2NvbmZpZ0dlbmVyYXRvcjtcbiAgfVxuXG4gIHByaXZhdGUgbG9nZ2VkT3V0cHV0VXJsID0gZmFsc2U7XG5cbiAgZ2V0SG9vayhuYW1lOiBzdHJpbmcpIHtcbiAgICBzd2l0Y2ggKG5hbWUpIHtcbiAgICAgIGNhc2UgJ3ByZVBhY2thZ2UnOlxuICAgICAgICB0aGlzLmlzUHJvZCA9IHRydWU7XG4gICAgICAgIHJldHVybiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgYXdhaXQgZnMucmVtb3ZlKHRoaXMuYmFzZURpcik7XG4gICAgICAgICAgYXdhaXQgdGhpcy5jb21waWxlTWFpbigpO1xuICAgICAgICAgIGF3YWl0IHRoaXMuY29tcGlsZVJlbmRlcmVycygpO1xuICAgICAgICB9O1xuICAgICAgY2FzZSAncG9zdFN0YXJ0JzpcbiAgICAgICAgcmV0dXJuIGFzeW5jIChfOiBhbnksIGNoaWxkOiBFbGVjdHJvblByb2Nlc3MpID0+IHtcbiAgICAgICAgICBpZiAoIXRoaXMubG9nZ2VkT3V0cHV0VXJsKSB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oYFxcblxcbldlYnBhY2sgT3V0cHV0IEF2YWlsYWJsZTogJHsoYGh0dHA6Ly9sb2NhbGhvc3Q6JHt0aGlzLmxvZ2dlclBvcnR9YCkuY3lhbn1cXG5gKTtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VkT3V0cHV0VXJsID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZCgnaG9va2luZyBlbGVjdHJvbiBwcm9jZXNzIGV4aXQnKTtcbiAgICAgICAgICBjaGlsZC5vbignZXhpdCcsICgpID0+IHtcbiAgICAgICAgICAgIGlmIChjaGlsZC5yZXN0YXJ0ZWQpIHJldHVybjtcbiAgICAgICAgICAgIHRoaXMuZXhpdEhhbmRsZXIoeyBjbGVhbnVwOiB0cnVlLCBleGl0OiB0cnVlIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgY2FzZSAncmVzb2x2ZUZvcmdlQ29uZmlnJzpcbiAgICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZUZvcmdlQ29uZmlnO1xuICAgICAgY2FzZSAncGFja2FnZUFmdGVyQ29weSc6XG4gICAgICAgIHJldHVybiB0aGlzLnBhY2thZ2VBZnRlckNvcHk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICByZXNvbHZlRm9yZ2VDb25maWcgPSBhc3luYyAoZm9yZ2VDb25maWc6IEZvcmdlQ29uZmlnKSA9PiB7XG4gICAgaWYgKCFmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZykge1xuICAgICAgZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcgPSB7fTtcbiAgICB9XG4gICAgaWYgKGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnLmlnbm9yZSkge1xuICAgICAgY29uc29sZS5lcnJvcihgWW91IGhhdmUgc2V0IHBhY2thZ2VyQ29uZmlnLmlnbm9yZSwgdGhlIEVsZWN0cm9uIEZvcmdlIHdlYnBhY2sgcGx1Z2luIG5vcm1hbGx5IHNldHMgdGhpcyBhdXRvbWF0aWNhbGx5LlxuXG5Zb3VyIHBhY2thZ2VkIGFwcCBtYXkgYmUgbGFyZ2VyIHRoYW4gZXhwZWN0ZWQgaWYgeW91IGRvbnQgaWdub3JlIGV2ZXJ5dGhpbmcgb3RoZXIgdGhhbiB0aGUgJy53ZWJwYWNrJyBmb2xkZXJgLnJlZCk7XG4gICAgICByZXR1cm4gZm9yZ2VDb25maWc7XG4gICAgfVxuICAgIGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnLmlnbm9yZSA9IChmaWxlOiBzdHJpbmcpID0+IHtcbiAgICAgIGlmICghZmlsZSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgICBpZiAodGhpcy5jb25maWcuanNvblN0YXRzICYmIGZpbGUuZW5kc1dpdGgocGF0aC5qb2luKCcud2VicGFjaycsICdtYWluJywgJ3N0YXRzLmpzb24nKSkpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmNvbmZpZy5yZW5kZXJlci5qc29uU3RhdHMgJiYgZmlsZS5lbmRzV2l0aChwYXRoLmpvaW4oJy53ZWJwYWNrJywgJ3JlbmRlcmVyJywgJ3N0YXRzLmpzb24nKSkpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiAhL15bL1xcXFxdXFwud2VicGFjaygkfFsvXFxcXF0pLiokLy50ZXN0KGZpbGUpO1xuICAgIH07XG4gICAgcmV0dXJuIGZvcmdlQ29uZmlnO1xuICB9XG5cbiAgcGFja2FnZUFmdGVyQ29weSA9IGFzeW5jIChfOiBhbnksIGJ1aWxkUGF0aDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgcGogPSBhd2FpdCBmcy5yZWFkSnNvbihwYXRoLnJlc29sdmUodGhpcy5wcm9qZWN0RGlyLCAncGFja2FnZS5qc29uJykpO1xuICAgIGlmIChwai5jb25maWcpIHtcbiAgICAgIGRlbGV0ZSBwai5jb25maWcuZm9yZ2U7XG4gICAgfVxuICAgIHBqLmRldkRlcGVuZGVuY2llcyA9IHt9O1xuICAgIHBqLmRlcGVuZGVuY2llcyA9IHt9O1xuICAgIHBqLm9wdGlvbmFsRGVwZW5kZW5jaWVzID0ge307XG4gICAgcGoucGVlckRlcGVuZGVuY2llcyA9IHt9O1xuXG4gICAgYXdhaXQgZnMud3JpdGVKc29uKFxuICAgICAgcGF0aC5yZXNvbHZlKGJ1aWxkUGF0aCwgJ3BhY2thZ2UuanNvbicpLFxuICAgICAgcGosXG4gICAgICB7XG4gICAgICAgIHNwYWNlczogMixcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGF3YWl0IGZzLm1rZGlycChwYXRoLnJlc29sdmUoYnVpbGRQYXRoLCAnbm9kZV9tb2R1bGVzJykpO1xuICB9XG5cbiAgY29tcGlsZU1haW4gPSBhc3luYyAod2F0Y2ggPSBmYWxzZSwgbG9nZ2VyPzogTG9nZ2VyKSA9PiB7XG4gICAgbGV0IHRhYjogVGFiO1xuICAgIGlmIChsb2dnZXIpIHtcbiAgICAgIHRhYiA9IGxvZ2dlci5jcmVhdGVUYWIoJ01haW4gUHJvY2VzcycpO1xuICAgIH1cbiAgICBhd2FpdCBhc3luY09yYSgnQ29tcGlsaW5nIE1haW4gUHJvY2VzcyBDb2RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbWFpbkNvbmZpZyA9IGF3YWl0IHRoaXMuY29uZmlnR2VuZXJhdG9yLmdldE1haW5Db25maWcoKTtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgY29tcGlsZXIgPSB3ZWJwYWNrKG1haW5Db25maWcpO1xuICAgICAgICBjb25zdCBbb25jZVJlc29sdmUsIG9uY2VSZWplY3RdID0gb25jZShyZXNvbHZlLCByZWplY3QpO1xuICAgICAgICBjb25zdCBjYjogV2VicGFja1dhdGNoSGFuZGxlciA9IGFzeW5jIChlcnIsIHN0YXRzKSA9PiB7XG4gICAgICAgICAgaWYgKHRhYiAmJiBzdGF0cykge1xuICAgICAgICAgICAgdGFiLmxvZyhzdGF0cy50b1N0cmluZyh7XG4gICAgICAgICAgICAgIGNvbG9yczogdHJ1ZSxcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHRoaXMuY29uZmlnLmpzb25TdGF0cykge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy53cml0ZUpTT05TdGF0cygnbWFpbicsIHN0YXRzLCBtYWluQ29uZmlnLnN0YXRzIGFzIFdlYnBhY2tUb0pzb25PcHRpb25zKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gb25jZVJlamVjdChlcnIpO1xuICAgICAgICAgIGlmICghd2F0Y2ggJiYgc3RhdHM/Lmhhc0Vycm9ycygpKSB7XG4gICAgICAgICAgICByZXR1cm4gb25jZVJlamVjdChuZXcgRXJyb3IoYENvbXBpbGF0aW9uIGVycm9ycyBpbiB0aGUgbWFpbiBwcm9jZXNzOiAke3N0YXRzLnRvU3RyaW5nKCl9YCkpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBvbmNlUmVzb2x2ZSh1bmRlZmluZWQpO1xuICAgICAgICB9O1xuICAgICAgICBpZiAod2F0Y2gpIHtcbiAgICAgICAgICB0aGlzLndhdGNoZXJzLnB1c2goY29tcGlsZXIud2F0Y2goe30sIGNiKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29tcGlsZXIucnVuKGNiKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBjb21waWxlUmVuZGVyZXJzID0gYXN5bmMgKHdhdGNoID0gZmFsc2UpID0+IHtcbiAgICBhd2FpdCBhc3luY09yYSgnQ29tcGlsaW5nIFJlbmRlcmVyIFRlbXBsYXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCB0aGlzLnJ1bldlYnBhY2soXG4gICAgICAgIGF3YWl0IHRoaXMuY29uZmlnR2VuZXJhdG9yLmdldFJlbmRlcmVyQ29uZmlnKHRoaXMuY29uZmlnLnJlbmRlcmVyLmVudHJ5UG9pbnRzKSxcbiAgICAgICAgdHJ1ZSxcbiAgICAgICk7XG4gICAgICBpZiAoIXdhdGNoICYmIHN0YXRzPy5oYXNFcnJvcnMoKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbXBpbGF0aW9uIGVycm9ycyBpbiB0aGUgcmVuZGVyZXI6ICR7c3RhdHMudG9TdHJpbmcoKX1gKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGZvciAoY29uc3QgZW50cnlQb2ludCBvZiB0aGlzLmNvbmZpZy5yZW5kZXJlci5lbnRyeVBvaW50cykge1xuICAgICAgaWYgKGVudHJ5UG9pbnQucHJlbG9hZCkge1xuICAgICAgICBhd2FpdCBhc3luY09yYShgQ29tcGlsaW5nIFJlbmRlcmVyIFByZWxvYWQ6ICR7ZW50cnlQb2ludC5uYW1lfWAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnJ1bldlYnBhY2soXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNvbmZpZ0dlbmVyYXRvci5nZXRQcmVsb2FkUmVuZGVyZXJDb25maWcoZW50cnlQb2ludCwgZW50cnlQb2ludC5wcmVsb2FkISksXG4gICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbGF1bmNoRGV2U2VydmVycyA9IGFzeW5jIChsb2dnZXI6IExvZ2dlcikgPT4ge1xuICAgIGF3YWl0IGFzeW5jT3JhKCdMYXVuY2ggRGV2IFNlcnZlcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB0YWIgPSBsb2dnZXIuY3JlYXRlVGFiKCdSZW5kZXJlcnMnKTtcbiAgICAgIGNvbnN0IHBsdWdpbkxvZ3MgPSBuZXcgRWxlY3Ryb25Gb3JnZUxvZ2dpbmdQbHVnaW4odGFiKTtcblxuICAgICAgY29uc3QgY29uZmlnID0gYXdhaXQgdGhpcy5jb25maWdHZW5lcmF0b3IuZ2V0UmVuZGVyZXJDb25maWcodGhpcy5jb25maWcucmVuZGVyZXIuZW50cnlQb2ludHMpO1xuICAgICAgaWYgKCFjb25maWcucGx1Z2lucykgY29uZmlnLnBsdWdpbnMgPSBbXTtcbiAgICAgIGNvbmZpZy5wbHVnaW5zLnB1c2gocGx1Z2luTG9ncyk7XG4gICAgICBjb25zdCBjb21waWxlciA9IHdlYnBhY2soY29uZmlnKTtcbiAgICAgIGNvbnN0IHdlYnBhY2tEZXZTZXJ2ZXIgPSBuZXcgV2VicGFja0RldlNlcnZlcihjb21waWxlciwge1xuICAgICAgICBob3Q6IHRydWUsXG4gICAgICAgIHBvcnQ6IHRoaXMucG9ydCxcbiAgICAgICAgc3RhdGljOiBwYXRoLnJlc29sdmUodGhpcy5iYXNlRGlyLCAncmVuZGVyZXInKSxcbiAgICAgICAgZGV2TWlkZGxld2FyZToge1xuICAgICAgICAgIHdyaXRlVG9EaXNrOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICBzZXR1cEV4aXRTaWduYWxzOiB0cnVlLFxuICAgICAgICBoaXN0b3J5QXBpRmFsbGJhY2s6IHRydWUsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHNlcnZlciA9IGF3YWl0IHdlYnBhY2tEZXZTZXJ2ZXIubGlzdGVuKHRoaXMucG9ydCk7XG4gICAgICB0aGlzLnNlcnZlcnMucHVzaChzZXJ2ZXIpO1xuICAgIH0pO1xuXG4gICAgYXdhaXQgYXN5bmNPcmEoJ0NvbXBpbGluZyBQcmVsb2FkIFNjcmlwdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBmb3IgKGNvbnN0IGVudHJ5UG9pbnQgb2YgdGhpcy5jb25maWcucmVuZGVyZXIuZW50cnlQb2ludHMpIHtcbiAgICAgICAgaWYgKGVudHJ5UG9pbnQucHJlbG9hZCkge1xuICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IGF3YWl0IHRoaXMuY29uZmlnR2VuZXJhdG9yLmdldFByZWxvYWRSZW5kZXJlckNvbmZpZyhcbiAgICAgICAgICAgIGVudHJ5UG9pbnQsXG4gICAgICAgICAgICBlbnRyeVBvaW50LnByZWxvYWQhLFxuICAgICAgICAgICk7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGFiID0gbG9nZ2VyLmNyZWF0ZVRhYihgJHtlbnRyeVBvaW50Lm5hbWV9IC0gUHJlbG9hZGApO1xuICAgICAgICAgICAgY29uc3QgW29uY2VSZXNvbHZlLCBvbmNlUmVqZWN0XSA9IG9uY2UocmVzb2x2ZSwgcmVqZWN0KTtcblxuICAgICAgICAgICAgdGhpcy53YXRjaGVycy5wdXNoKHdlYnBhY2soY29uZmlnKS53YXRjaCh7fSwgKGVyciwgc3RhdHMpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHN0YXRzKSB7XG4gICAgICAgICAgICAgICAgdGFiLmxvZyhzdGF0cy50b1N0cmluZyh7XG4gICAgICAgICAgICAgICAgICBjb2xvcnM6IHRydWUsXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKGVycikgcmV0dXJuIG9uY2VSZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgcmV0dXJuIG9uY2VSZXNvbHZlKHVuZGVmaW5lZCk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWxyZWFkeVN0YXJ0ZWQgPSBmYWxzZTtcblxuICBhc3luYyBzdGFydExvZ2ljKCk6IFByb21pc2U8ZmFsc2U+IHtcbiAgICBpZiAodGhpcy5hbHJlYWR5U3RhcnRlZCkgcmV0dXJuIGZhbHNlO1xuICAgIHRoaXMuYWxyZWFkeVN0YXJ0ZWQgPSB0cnVlO1xuXG4gICAgYXdhaXQgZnMucmVtb3ZlKHRoaXMuYmFzZURpcik7XG5cbiAgICBjb25zdCBsb2dnZXIgPSBuZXcgTG9nZ2VyKHRoaXMubG9nZ2VyUG9ydCk7XG4gICAgdGhpcy5sb2dnZXJzLnB1c2gobG9nZ2VyKTtcbiAgICBhd2FpdCB0aGlzLmNvbXBpbGVNYWluKHRydWUsIGxvZ2dlcik7XG4gICAgYXdhaXQgdGhpcy5sYXVuY2hEZXZTZXJ2ZXJzKGxvZ2dlcik7XG4gICAgYXdhaXQgbG9nZ2VyLnN0YXJ0KCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG4iXX0=