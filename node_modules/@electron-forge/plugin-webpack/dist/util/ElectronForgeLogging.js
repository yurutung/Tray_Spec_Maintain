"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _asyncOra = require("@electron-forge/async-ora");

var _once = _interopRequireDefault(require("./once"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const pluginName = 'ElectronForgeLogging';

class LoggingPlugin {
  constructor(tab) {
    _defineProperty(this, "tab", void 0);

    _defineProperty(this, "promiseResolver", void 0);

    _defineProperty(this, "promiseRejector", void 0);

    this.tab = tab;
    this.promiseResolver = undefined;
    this.promiseRejector = undefined;
  }

  addRun() {
    if (this.promiseResolver) this.promiseResolver();
    (0, _asyncOra.asyncOra)('Compiling Renderer Code', () => new Promise((resolve, reject) => {
      const [onceResolve, onceReject] = (0, _once.default)(resolve, reject);
      this.promiseResolver = onceResolve;
      this.promiseRejector = onceReject;
    }), () => {});
  }

  finishRun(error) {
    if (error && this.promiseRejector) this.promiseRejector(error);else if (this.promiseResolver) this.promiseResolver();
    this.promiseRejector = undefined;
    this.promiseResolver = undefined;
  }

  apply(compiler) {
    compiler.hooks.watchRun.tap(pluginName, _compiler => {
      this.addRun();
    });
    compiler.hooks.done.tap(pluginName, stats => {
      if (stats) {
        this.tab.log(stats.toString({
          colors: true
        }));

        if (stats.hasErrors()) {
          this.finishRun(stats.compilation.getErrors().toString());
          return;
        }
      }

      this.finishRun();
    });
    compiler.hooks.failed.tap(pluginName, err => this.finishRun(err.message));
    compiler.hooks.infrastructureLog.tap(pluginName, (name, _type, args) => {
      this.tab.log(`${name} - ${args.join(' ')}\n`);
      return true;
    });
  }

}

exports.default = LoggingPlugin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL0VsZWN0cm9uRm9yZ2VMb2dnaW5nLnRzIl0sIm5hbWVzIjpbInBsdWdpbk5hbWUiLCJMb2dnaW5nUGx1Z2luIiwiY29uc3RydWN0b3IiLCJ0YWIiLCJwcm9taXNlUmVzb2x2ZXIiLCJ1bmRlZmluZWQiLCJwcm9taXNlUmVqZWN0b3IiLCJhZGRSdW4iLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9uY2VSZXNvbHZlIiwib25jZVJlamVjdCIsImZpbmlzaFJ1biIsImVycm9yIiwiYXBwbHkiLCJjb21waWxlciIsImhvb2tzIiwid2F0Y2hSdW4iLCJ0YXAiLCJfY29tcGlsZXIiLCJkb25lIiwic3RhdHMiLCJsb2ciLCJ0b1N0cmluZyIsImNvbG9ycyIsImhhc0Vycm9ycyIsImNvbXBpbGF0aW9uIiwiZ2V0RXJyb3JzIiwiZmFpbGVkIiwiZXJyIiwibWVzc2FnZSIsImluZnJhc3RydWN0dXJlTG9nIiwibmFtZSIsIl90eXBlIiwiYXJncyIsImpvaW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUdBOzs7Ozs7QUFFQSxNQUFNQSxVQUFVLEdBQUcsc0JBQW5COztBQUVlLE1BQU1DLGFBQU4sQ0FBb0I7QUFPakNDLEVBQUFBLFdBQVcsQ0FBQ0MsR0FBRCxFQUFXO0FBQUE7O0FBQUE7O0FBQUE7O0FBQ3BCLFNBQUtBLEdBQUwsR0FBV0EsR0FBWDtBQUNBLFNBQUtDLGVBQUwsR0FBdUJDLFNBQXZCO0FBQ0EsU0FBS0MsZUFBTCxHQUF1QkQsU0FBdkI7QUFDRDs7QUFFT0UsRUFBQUEsTUFBTSxHQUFHO0FBQ2YsUUFBSSxLQUFLSCxlQUFULEVBQTBCLEtBQUtBLGVBQUw7QUFDMUIsNEJBQVMseUJBQVQsRUFBb0MsTUFBTSxJQUFJSSxPQUFKLENBQWtCLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUMvRSxZQUFNLENBQUNDLFdBQUQsRUFBY0MsVUFBZCxJQUE0QixtQkFBS0gsT0FBTCxFQUFjQyxNQUFkLENBQWxDO0FBQ0EsV0FBS04sZUFBTCxHQUF1Qk8sV0FBdkI7QUFDQSxXQUFLTCxlQUFMLEdBQXVCTSxVQUF2QjtBQUNELEtBSnlDLENBQTFDLEVBSUksTUFBTSxDQUFFLENBSlo7QUFLRDs7QUFFT0MsRUFBQUEsU0FBUyxDQUFDQyxLQUFELEVBQWlCO0FBQ2hDLFFBQUlBLEtBQUssSUFBSSxLQUFLUixlQUFsQixFQUFtQyxLQUFLQSxlQUFMLENBQXFCUSxLQUFyQixFQUFuQyxLQUNLLElBQUksS0FBS1YsZUFBVCxFQUEwQixLQUFLQSxlQUFMO0FBQy9CLFNBQUtFLGVBQUwsR0FBdUJELFNBQXZCO0FBQ0EsU0FBS0QsZUFBTCxHQUF1QkMsU0FBdkI7QUFDRDs7QUFFRFUsRUFBQUEsS0FBSyxDQUFDQyxRQUFELEVBQXFCO0FBQ3hCQSxJQUFBQSxRQUFRLENBQUNDLEtBQVQsQ0FBZUMsUUFBZixDQUF3QkMsR0FBeEIsQ0FBNEJuQixVQUE1QixFQUF5Q29CLFNBQUQsSUFBZTtBQUNyRCxXQUFLYixNQUFMO0FBQ0QsS0FGRDtBQUdBUyxJQUFBQSxRQUFRLENBQUNDLEtBQVQsQ0FBZUksSUFBZixDQUFvQkYsR0FBcEIsQ0FBd0JuQixVQUF4QixFQUFxQ3NCLEtBQUQsSUFBVztBQUM3QyxVQUFJQSxLQUFKLEVBQVc7QUFDVCxhQUFLbkIsR0FBTCxDQUFTb0IsR0FBVCxDQUFhRCxLQUFLLENBQUNFLFFBQU4sQ0FBZTtBQUMxQkMsVUFBQUEsTUFBTSxFQUFFO0FBRGtCLFNBQWYsQ0FBYjs7QUFHQSxZQUFJSCxLQUFLLENBQUNJLFNBQU4sRUFBSixFQUF1QjtBQUNyQixlQUFLYixTQUFMLENBQWVTLEtBQUssQ0FBQ0ssV0FBTixDQUFrQkMsU0FBbEIsR0FBOEJKLFFBQTlCLEVBQWY7QUFDQTtBQUNEO0FBQ0Y7O0FBQ0QsV0FBS1gsU0FBTDtBQUNELEtBWEQ7QUFZQUcsSUFBQUEsUUFBUSxDQUFDQyxLQUFULENBQWVZLE1BQWYsQ0FBc0JWLEdBQXRCLENBQTBCbkIsVUFBMUIsRUFBdUM4QixHQUFELElBQVMsS0FBS2pCLFNBQUwsQ0FBZWlCLEdBQUcsQ0FBQ0MsT0FBbkIsQ0FBL0M7QUFDQWYsSUFBQUEsUUFBUSxDQUFDQyxLQUFULENBQWVlLGlCQUFmLENBQWlDYixHQUFqQyxDQUNFbkIsVUFERixFQUVFLENBQUNpQyxJQUFELEVBQWVDLEtBQWYsRUFBOEJDLElBQTlCLEtBQWlEO0FBQy9DLFdBQUtoQyxHQUFMLENBQVNvQixHQUFULENBQWMsR0FBRVUsSUFBSyxNQUFLRSxJQUFJLENBQUNDLElBQUwsQ0FBVSxHQUFWLENBQWUsSUFBekM7QUFDQSxhQUFPLElBQVA7QUFDRCxLQUxIO0FBT0Q7O0FBckRnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzeW5jT3JhIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2FzeW5jLW9yYSc7XG5pbXBvcnQgeyBUYWIgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvd2ViLW11bHRpLWxvZ2dlcic7XG5pbXBvcnQgeyBDb21waWxlciB9IGZyb20gJ3dlYnBhY2snO1xuaW1wb3J0IG9uY2UgZnJvbSAnLi9vbmNlJztcblxuY29uc3QgcGx1Z2luTmFtZSA9ICdFbGVjdHJvbkZvcmdlTG9nZ2luZyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIExvZ2dpbmdQbHVnaW4ge1xuICB0YWI6IFRhYjtcblxuICBwcm9taXNlUmVzb2x2ZXI6ICgoKSA9PiB2b2lkKSB8IHVuZGVmaW5lZDtcblxuICBwcm9taXNlUmVqZWN0b3I6ICgocmVhc29uPzogYW55KSA9PiB2b2lkKSB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcih0YWI6IFRhYikge1xuICAgIHRoaXMudGFiID0gdGFiO1xuICAgIHRoaXMucHJvbWlzZVJlc29sdmVyID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucHJvbWlzZVJlamVjdG9yID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRSdW4oKSB7XG4gICAgaWYgKHRoaXMucHJvbWlzZVJlc29sdmVyKSB0aGlzLnByb21pc2VSZXNvbHZlcigpO1xuICAgIGFzeW5jT3JhKCdDb21waWxpbmcgUmVuZGVyZXIgQ29kZScsICgpID0+IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IFtvbmNlUmVzb2x2ZSwgb25jZVJlamVjdF0gPSBvbmNlKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICB0aGlzLnByb21pc2VSZXNvbHZlciA9IG9uY2VSZXNvbHZlO1xuICAgICAgdGhpcy5wcm9taXNlUmVqZWN0b3IgPSBvbmNlUmVqZWN0O1xuICAgIH0pLCAoKSA9PiB7fSk7XG4gIH1cblxuICBwcml2YXRlIGZpbmlzaFJ1bihlcnJvcj86IHN0cmluZykge1xuICAgIGlmIChlcnJvciAmJiB0aGlzLnByb21pc2VSZWplY3RvcikgdGhpcy5wcm9taXNlUmVqZWN0b3IoZXJyb3IpO1xuICAgIGVsc2UgaWYgKHRoaXMucHJvbWlzZVJlc29sdmVyKSB0aGlzLnByb21pc2VSZXNvbHZlcigpO1xuICAgIHRoaXMucHJvbWlzZVJlamVjdG9yID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucHJvbWlzZVJlc29sdmVyID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgYXBwbHkoY29tcGlsZXI6IENvbXBpbGVyKSB7XG4gICAgY29tcGlsZXIuaG9va3Mud2F0Y2hSdW4udGFwKHBsdWdpbk5hbWUsIChfY29tcGlsZXIpID0+IHtcbiAgICAgIHRoaXMuYWRkUnVuKCk7XG4gICAgfSk7XG4gICAgY29tcGlsZXIuaG9va3MuZG9uZS50YXAocGx1Z2luTmFtZSwgKHN0YXRzKSA9PiB7XG4gICAgICBpZiAoc3RhdHMpIHtcbiAgICAgICAgdGhpcy50YWIubG9nKHN0YXRzLnRvU3RyaW5nKHtcbiAgICAgICAgICBjb2xvcnM6IHRydWUsXG4gICAgICAgIH0pKTtcbiAgICAgICAgaWYgKHN0YXRzLmhhc0Vycm9ycygpKSB7XG4gICAgICAgICAgdGhpcy5maW5pc2hSdW4oc3RhdHMuY29tcGlsYXRpb24uZ2V0RXJyb3JzKCkudG9TdHJpbmcoKSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmZpbmlzaFJ1bigpO1xuICAgIH0pO1xuICAgIGNvbXBpbGVyLmhvb2tzLmZhaWxlZC50YXAocGx1Z2luTmFtZSwgKGVycikgPT4gdGhpcy5maW5pc2hSdW4oZXJyLm1lc3NhZ2UpKTtcbiAgICBjb21waWxlci5ob29rcy5pbmZyYXN0cnVjdHVyZUxvZy50YXAoXG4gICAgICBwbHVnaW5OYW1lLFxuICAgICAgKG5hbWU6IHN0cmluZywgX3R5cGU6IHN0cmluZywgYXJnczogc3RyaW5nW10pID0+IHtcbiAgICAgICAgdGhpcy50YWIubG9nKGAke25hbWV9IC0gJHthcmdzLmpvaW4oJyAnKX1cXG5gKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cbiJdfQ==