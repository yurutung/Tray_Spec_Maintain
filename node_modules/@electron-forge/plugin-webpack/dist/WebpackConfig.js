"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _debug = _interopRequireDefault(require("debug"));

var _htmlWebpackPlugin = _interopRequireDefault(require("html-webpack-plugin"));

var _path = _interopRequireDefault(require("path"));

var _webpack = _interopRequireDefault(require("webpack"));

var _webpackMerge = require("webpack-merge");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const d = (0, _debug.default)('electron-forge:plugin:webpack:webpackconfig');

class WebpackConfigGenerator {
  constructor(pluginConfig, projectDir, isProd, port) {
    _defineProperty(this, "isProd", void 0);

    _defineProperty(this, "pluginConfig", void 0);

    _defineProperty(this, "port", void 0);

    _defineProperty(this, "projectDir", void 0);

    _defineProperty(this, "webpackDir", void 0);

    this.pluginConfig = pluginConfig;
    this.projectDir = projectDir;
    this.webpackDir = _path.default.resolve(projectDir, '.webpack');
    this.isProd = isProd;
    this.port = port;
    d('Config mode:', this.mode);
  }

  resolveConfig(config) {
    if (typeof config === 'string') {
      // eslint-disable-next-line import/no-dynamic-require, global-require
      return require(_path.default.resolve(this.projectDir, config));
    }

    return config;
  }

  get mode() {
    return this.isProd ? 'production' : 'development';
  }

  rendererEntryPoint(entryPoint, inRendererDir, basename) {
    if (this.isProd) {
      return `\`file://$\{require('path').resolve(__dirname, '..', '${inRendererDir ? 'renderer' : '.'}', '${entryPoint.name}', '${basename}')}\``;
    }

    const baseUrl = `http://localhost:${this.port}/${entryPoint.name}`;

    if (basename !== 'index.html') {
      return `'${baseUrl}/${basename}'`;
    }

    return `'${baseUrl}'`;
  }

  toEnvironmentVariable(entryPoint, preload = false) {
    const suffix = preload ? '_PRELOAD_WEBPACK_ENTRY' : '_WEBPACK_ENTRY';
    return `${entryPoint.name.toUpperCase().replace(/ /g, '_')}${suffix}`;
  }

  getPreloadDefine(entryPoint) {
    if (entryPoint.preload) {
      if (this.isProd) {
        return `require('path').resolve(__dirname, '../renderer', '${entryPoint.name}', 'preload.js')`;
      }

      return `'${_path.default.resolve(this.webpackDir, 'renderer', entryPoint.name, 'preload.js').replace(/\\/g, '\\\\')}'`;
    } // If this entry-point has no configured preload script just map this constant to `undefined`
    // so that any code using it still works.  This makes quick-start / docs simpler.


    return 'undefined';
  }

  assetRelocatorBaseDir(inRendererDir = true) {
    if (this.isProd) {
      return `process.resourcesPath + "/" + (__filename.includes(".asar") ? "app.asar" : "app") + "/.webpack/${inRendererDir ? 'main' : 'renderer/any_folder'}"`;
    }

    return JSON.stringify(_path.default.resolve(this.webpackDir, inRendererDir ? 'main' : 'renderer', inRendererDir ? '.' : 'any_folder'));
  }

  getDefines(inRendererDir = true) {
    const defines = {
      ASSET_RELOCATOR_BASE_DIR: this.assetRelocatorBaseDir(inRendererDir)
    };

    if (!this.pluginConfig.renderer.entryPoints || !Array.isArray(this.pluginConfig.renderer.entryPoints)) {
      throw new Error('Required config option "renderer.entryPoints" has not been defined');
    }

    for (const entryPoint of this.pluginConfig.renderer.entryPoints) {
      const entryKey = this.toEnvironmentVariable(entryPoint);

      if (entryPoint.html) {
        defines[entryKey] = this.rendererEntryPoint(entryPoint, inRendererDir, 'index.html');
      } else {
        defines[entryKey] = this.rendererEntryPoint(entryPoint, inRendererDir, 'index.js');
      }

      defines[`process.env.${entryKey}`] = defines[entryKey];
      const preloadDefineKey = this.toEnvironmentVariable(entryPoint, true);
      defines[preloadDefineKey] = this.getPreloadDefine(entryPoint);
      defines[`process.env.${preloadDefineKey}`] = defines[preloadDefineKey];
    }

    return defines;
  }

  sourceMapOption() {
    return this.isProd ? 'source-map' : 'eval-source-map';
  }

  getMainConfig() {
    const mainConfig = this.resolveConfig(this.pluginConfig.mainConfig);

    if (!mainConfig.entry) {
      throw new Error('Required option "mainConfig.entry" has not been defined');
    }

    const fix = item => {
      if (typeof item === 'string') return fix([item])[0];

      if (Array.isArray(item)) {
        return item.map(val => val.startsWith('./') ? _path.default.resolve(this.projectDir, val) : val);
      }

      const ret = {};

      for (const key of Object.keys(item)) {
        ret[key] = fix(item[key]);
      }

      return ret;
    };

    mainConfig.entry = fix(mainConfig.entry);
    return (0, _webpackMerge.merge)({
      devtool: 'source-map',
      target: 'electron-main',
      mode: this.mode,
      output: {
        path: _path.default.resolve(this.webpackDir, 'main'),
        filename: 'index.js',
        libraryTarget: 'commonjs2'
      },
      plugins: [new _webpack.default.DefinePlugin(this.getDefines())],
      node: {
        __dirname: false,
        __filename: false
      },
      resolve: {
        modules: [_path.default.resolve(_path.default.dirname(this.webpackDir), './'), _path.default.resolve(_path.default.dirname(this.webpackDir), 'node_modules'), _path.default.resolve(__dirname, '..', 'node_modules')]
      }
    }, mainConfig || {});
  }

  async getPreloadRendererConfig(parentPoint, entryPoint) {
    const rendererConfig = this.resolveConfig(this.pluginConfig.renderer.config);
    const prefixedEntries = entryPoint.prefixedEntries || [];
    return (0, _webpackMerge.merge)({
      devtool: this.sourceMapOption(),
      mode: this.mode,
      entry: prefixedEntries.concat([entryPoint.js]),
      output: {
        path: _path.default.resolve(this.webpackDir, 'renderer', parentPoint.name),
        filename: 'preload.js'
      },
      node: {
        __dirname: false,
        __filename: false
      }
    }, rendererConfig || {}, {
      target: 'electron-preload'
    });
  }

  async getRendererConfig(entryPoints) {
    const rendererConfig = this.resolveConfig(this.pluginConfig.renderer.config);
    const entry = {};

    for (const entryPoint of entryPoints) {
      const prefixedEntries = entryPoint.prefixedEntries || [];
      entry[entryPoint.name] = prefixedEntries.concat([entryPoint.js]);
    }

    const defines = this.getDefines(false);
    const plugins = entryPoints.filter(entryPoint => Boolean(entryPoint.html)).map(entryPoint => new _htmlWebpackPlugin.default({
      title: entryPoint.name,
      template: entryPoint.html,
      filename: `${entryPoint.name}/index.html`,
      chunks: [entryPoint.name].concat(entryPoint.additionalChunks || [])
    })).concat([new _webpack.default.DefinePlugin(defines)]);
    return (0, _webpackMerge.merge)({
      entry,
      devtool: this.sourceMapOption(),
      target: ['web', 'electron-renderer'],
      mode: this.mode,
      output: {
        path: _path.default.resolve(this.webpackDir, 'renderer'),
        filename: '[name]/index.js',
        globalObject: 'self',
        ...(this.isProd ? {} : {
          publicPath: '/'
        })
      },
      node: {
        __dirname: false,
        __filename: false
      },
      plugins
    }, rendererConfig || {});
  }

}

exports.default = WebpackConfigGenerator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9XZWJwYWNrQ29uZmlnLnRzIl0sIm5hbWVzIjpbImQiLCJXZWJwYWNrQ29uZmlnR2VuZXJhdG9yIiwiY29uc3RydWN0b3IiLCJwbHVnaW5Db25maWciLCJwcm9qZWN0RGlyIiwiaXNQcm9kIiwicG9ydCIsIndlYnBhY2tEaXIiLCJwYXRoIiwicmVzb2x2ZSIsIm1vZGUiLCJyZXNvbHZlQ29uZmlnIiwiY29uZmlnIiwicmVxdWlyZSIsInJlbmRlcmVyRW50cnlQb2ludCIsImVudHJ5UG9pbnQiLCJpblJlbmRlcmVyRGlyIiwiYmFzZW5hbWUiLCJuYW1lIiwiYmFzZVVybCIsInRvRW52aXJvbm1lbnRWYXJpYWJsZSIsInByZWxvYWQiLCJzdWZmaXgiLCJ0b1VwcGVyQ2FzZSIsInJlcGxhY2UiLCJnZXRQcmVsb2FkRGVmaW5lIiwiYXNzZXRSZWxvY2F0b3JCYXNlRGlyIiwiSlNPTiIsInN0cmluZ2lmeSIsImdldERlZmluZXMiLCJkZWZpbmVzIiwiQVNTRVRfUkVMT0NBVE9SX0JBU0VfRElSIiwicmVuZGVyZXIiLCJlbnRyeVBvaW50cyIsIkFycmF5IiwiaXNBcnJheSIsIkVycm9yIiwiZW50cnlLZXkiLCJodG1sIiwicHJlbG9hZERlZmluZUtleSIsInNvdXJjZU1hcE9wdGlvbiIsImdldE1haW5Db25maWciLCJtYWluQ29uZmlnIiwiZW50cnkiLCJmaXgiLCJpdGVtIiwibWFwIiwidmFsIiwic3RhcnRzV2l0aCIsInJldCIsImtleSIsIk9iamVjdCIsImtleXMiLCJkZXZ0b29sIiwidGFyZ2V0Iiwib3V0cHV0IiwiZmlsZW5hbWUiLCJsaWJyYXJ5VGFyZ2V0IiwicGx1Z2lucyIsIndlYnBhY2siLCJEZWZpbmVQbHVnaW4iLCJub2RlIiwiX19kaXJuYW1lIiwiX19maWxlbmFtZSIsIm1vZHVsZXMiLCJkaXJuYW1lIiwiZ2V0UHJlbG9hZFJlbmRlcmVyQ29uZmlnIiwicGFyZW50UG9pbnQiLCJyZW5kZXJlckNvbmZpZyIsInByZWZpeGVkRW50cmllcyIsImNvbmNhdCIsImpzIiwiZ2V0UmVuZGVyZXJDb25maWciLCJmaWx0ZXIiLCJCb29sZWFuIiwiSHRtbFdlYnBhY2tQbHVnaW4iLCJ0aXRsZSIsInRlbXBsYXRlIiwiY2h1bmtzIiwiYWRkaXRpb25hbENodW5rcyIsImdsb2JhbE9iamVjdCIsInB1YmxpY1BhdGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFLQSxNQUFNQSxDQUFDLEdBQUcsb0JBQU0sNkNBQU4sQ0FBVjs7QUFFZSxNQUFNQyxzQkFBTixDQUE2QjtBQVcxQ0MsRUFBQUEsV0FBVyxDQUNUQyxZQURTLEVBRVRDLFVBRlMsRUFHVEMsTUFIUyxFQUlUQyxJQUpTLEVBS1Q7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFDQSxTQUFLSCxZQUFMLEdBQW9CQSxZQUFwQjtBQUNBLFNBQUtDLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0csVUFBTCxHQUFrQkMsY0FBS0MsT0FBTCxDQUFhTCxVQUFiLEVBQXlCLFVBQXpCLENBQWxCO0FBQ0EsU0FBS0MsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBRUFOLElBQUFBLENBQUMsQ0FBQyxjQUFELEVBQWlCLEtBQUtVLElBQXRCLENBQUQ7QUFDRDs7QUFFREMsRUFBQUEsYUFBYSxDQUFDQyxNQUFELEVBQWlDO0FBQzVDLFFBQUksT0FBT0EsTUFBUCxLQUFrQixRQUF0QixFQUFnQztBQUM5QjtBQUNBLGFBQU9DLE9BQU8sQ0FBQ0wsY0FBS0MsT0FBTCxDQUFhLEtBQUtMLFVBQWxCLEVBQThCUSxNQUE5QixDQUFELENBQWQ7QUFDRDs7QUFFRCxXQUFPQSxNQUFQO0FBQ0Q7O0FBRU8sTUFBSkYsSUFBSSxHQUFHO0FBQ1QsV0FBTyxLQUFLTCxNQUFMLEdBQWMsWUFBZCxHQUE2QixhQUFwQztBQUNEOztBQUVEUyxFQUFBQSxrQkFBa0IsQ0FDaEJDLFVBRGdCLEVBRWhCQyxhQUZnQixFQUdoQkMs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QkFBUixDQUhVO0FBSWxCNUMsTUFBQUEsSUFBSSxFQUFFLEtBQUtBLElBSk87QUFLbEI2QyxNQUFBQSxNQUFNLEVBQUU7QUFDTi9DLFFBQUFBLElBQUksRUFBRUEsY0FBS0MsT0FBTCxDQUFhLEtBQUtGLFVBQWxCLEVBQThCLFVBQTlCLENBREE7QUFFTmlELFFBQUFBLFFBQVEsRUFBRSxpQkFGSjtBQUdOd0IsUUFBQUEsWUFBWSxFQUFFLE1BSFI7QUFJTixZQUFJLEtBQUszRSxNQUFMLEdBQWMsRUFBZCxHQUFtQjtBQUFFNEUsVUFBQUEsVUFBVSxFQUFFO0FBQWQsU0FBdkI7QUFKTSxPQUxVO0FBV2xCcEIsTUFBQUEsSUFBSSxFQUFFO0FBQ0pDLFFBQUFBLFNBQVMsRUFBRSxLQURQO0FBRUpDLFFBQUFBLFVBQVUsRUFBRTtBQUZSLE9BWFk7QUFlbEJMLE1BQUFBO0FBZmtCLEtBQWIsRUFnQkpVLGNBQWMsSUFBSSxFQWhCZCxDQUFQO0FBaUJEOztBQTVOeUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IEh0bWxXZWJwYWNrUGx1Z2luIGZyb20gJ2h0bWwtd2VicGFjay1wbHVnaW4nO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgd2VicGFjaywgeyBDb25maWd1cmF0aW9uLCBXZWJwYWNrUGx1Z2luSW5zdGFuY2UgfSBmcm9tICd3ZWJwYWNrJztcbmltcG9ydCB7IG1lcmdlIGFzIHdlYnBhY2tNZXJnZSB9IGZyb20gJ3dlYnBhY2stbWVyZ2UnO1xuaW1wb3J0IHsgV2VicGFja1BsdWdpbkNvbmZpZywgV2VicGFja1BsdWdpbkVudHJ5UG9pbnQsIFdlYnBhY2tQcmVsb2FkRW50cnlQb2ludCB9IGZyb20gJy4vQ29uZmlnJztcblxudHlwZSBFbnRyeVR5cGUgPSBzdHJpbmcgfCBzdHJpbmdbXSB8IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHN0cmluZ1tdPjtcblxuY29uc3QgZCA9IGRlYnVnKCdlbGVjdHJvbi1mb3JnZTpwbHVnaW46d2VicGFjazp3ZWJwYWNrY29uZmlnJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdlYnBhY2tDb25maWdHZW5lcmF0b3Ige1xuICBwcml2YXRlIGlzUHJvZDogYm9vbGVhbjtcblxuICBwcml2YXRlIHBsdWdpbkNvbmZpZzogV2VicGFja1BsdWdpbkNvbmZpZztcblxuICBwcml2YXRlIHBvcnQ6IG51bWJlcjtcblxuICBwcml2YXRlIHByb2plY3REaXI6IHN0cmluZztcblxuICBwcml2YXRlIHdlYnBhY2tEaXI6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwbHVnaW5Db25maWc6IFdlYnBhY2tQbHVnaW5Db25maWcsXG4gICAgcHJvamVjdERpcjogc3RyaW5nLFxuICAgIGlzUHJvZDogYm9vbGVhbixcbiAgICBwb3J0OiBudW1iZXIsXG4gICkge1xuICAgIHRoaXMucGx1Z2luQ29uZmlnID0gcGx1Z2luQ29uZmlnO1xuICAgIHRoaXMucHJvamVjdERpciA9IHByb2plY3REaXI7XG4gICAgdGhpcy53ZWJwYWNrRGlyID0gcGF0aC5yZXNvbHZlKHByb2plY3REaXIsICcud2VicGFjaycpO1xuICAgIHRoaXMuaXNQcm9kID0gaXNQcm9kO1xuICAgIHRoaXMucG9ydCA9IHBvcnQ7XG5cbiAgICBkKCdDb25maWcgbW9kZTonLCB0aGlzLm1vZGUpO1xuICB9XG5cbiAgcmVzb2x2ZUNvbmZpZyhjb25maWc6IENvbmZpZ3VyYXRpb24gfCBzdHJpbmcpIHtcbiAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlLCBnbG9iYWwtcmVxdWlyZVxuICAgICAgcmV0dXJuIHJlcXVpcmUocGF0aC5yZXNvbHZlKHRoaXMucHJvamVjdERpciwgY29uZmlnKSkgYXMgQ29uZmlndXJhdGlvbjtcbiAgICB9XG5cbiAgICByZXR1cm4gY29uZmlnO1xuICB9XG5cbiAgZ2V0IG1vZGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNQcm9kID8gJ3Byb2R1Y3Rpb24nIDogJ2RldmVsb3BtZW50JztcbiAgfVxuXG4gIHJlbmRlcmVyRW50cnlQb2ludChcbiAgICBlbnRyeVBvaW50OiBXZWJwYWNrUGx1Z2luRW50cnlQb2ludCxcbiAgICBpblJlbmRlcmVyRGlyOiBib29sZWFuLFxuICAgIGJhc2VuYW1lOiBzdHJpbmcsXG4gICk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMuaXNQcm9kKSB7XG4gICAgICByZXR1cm4gYFxcYGZpbGU6Ly8kXFx7cmVxdWlyZSgncGF0aCcpLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnJHtpblJlbmRlcmVyRGlyID8gJ3JlbmRlcmVyJyA6ICcuJ30nLCAnJHtlbnRyeVBvaW50Lm5hbWV9JywgJyR7YmFzZW5hbWV9Jyl9XFxgYDtcbiAgICB9XG4gICAgY29uc3QgYmFzZVVybCA9IGBodHRwOi8vbG9jYWxob3N0OiR7dGhpcy5wb3J0fS8ke2VudHJ5UG9pbnQubmFtZX1gO1xuICAgIGlmIChiYXNlbmFtZSAhPT0gJ2luZGV4Lmh0bWwnKSB7XG4gICAgICByZXR1cm4gYCcke2Jhc2VVcmx9LyR7YmFzZW5hbWV9J2A7XG4gICAgfVxuICAgIHJldHVybiBgJyR7YmFzZVVybH0nYDtcbiAgfVxuXG4gIHRvRW52aXJvbm1lbnRWYXJpYWJsZShlbnRyeVBvaW50OiBXZWJwYWNrUGx1Z2luRW50cnlQb2ludCwgcHJlbG9hZCA9IGZhbHNlKTogc3RyaW5nIHtcbiAgICBjb25zdCBzdWZmaXggPSBwcmVsb2FkID8gJ19QUkVMT0FEX1dFQlBBQ0tfRU5UUlknIDogJ19XRUJQQUNLX0VOVFJZJztcbiAgICByZXR1cm4gYCR7ZW50cnlQb2ludC5uYW1lLnRvVXBwZXJDYXNlKCkucmVwbGFjZSgvIC9nLCAnXycpfSR7c3VmZml4fWA7XG4gIH1cblxuICBnZXRQcmVsb2FkRGVmaW5lKGVudHJ5UG9pbnQ6IFdlYnBhY2tQbHVnaW5FbnRyeVBvaW50KTogc3RyaW5nIHtcbiAgICBpZiAoZW50cnlQb2ludC5wcmVsb2FkKSB7XG4gICAgICBpZiAodGhpcy5pc1Byb2QpIHtcbiAgICAgICAgcmV0dXJuIGByZXF1aXJlKCdwYXRoJykucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi9yZW5kZXJlcicsICcke2VudHJ5UG9pbnQubmFtZX0nLCAncHJlbG9hZC5qcycpYDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBgJyR7cGF0aC5yZXNvbHZlKHRoaXMud2VicGFja0RpciwgJ3JlbmRlcmVyJywgZW50cnlQb2ludC5uYW1lLCAncHJlbG9hZC5qcycpLnJlcGxhY2UoL1xcXFwvZywgJ1xcXFxcXFxcJyl9J2A7XG4gICAgfVxuICAgIC8vIElmIHRoaXMgZW50cnktcG9pbnQgaGFzIG5vIGNvbmZpZ3VyZWQgcHJlbG9hZCBzY3JpcHQganVzdCBtYXAgdGhpcyBjb25zdGFudCB0byBgdW5kZWZpbmVkYFxuICAgIC8vIHNvIHRoYXQgYW55IGNvZGUgdXNpbmcgaXQgc3RpbGwgd29ya3MuICBUaGlzIG1ha2VzIHF1aWNrLXN0YXJ0IC8gZG9jcyBzaW1wbGVyLlxuICAgIHJldHVybiAndW5kZWZpbmVkJztcbiAgfVxuXG4gIGFzc2V0UmVsb2NhdG9yQmFzZURpcihpblJlbmRlcmVyRGlyID0gdHJ1ZSkge1xuICAgIGlmICh0aGlzLmlzUHJvZCkge1xuICAgICAgcmV0dXJuIGBwcm9jZXNzLnJlc291cmNlc1BhdGggKyBcIi9cIiArIChfX2ZpbGVuYW1lLmluY2x1ZGVzKFwiLmFzYXJcIikgPyBcImFwcC5hc2FyXCIgOiBcImFwcFwiKSArIFwiLy53ZWJwYWNrLyR7aW5SZW5kZXJlckRpciA/ICdtYWluJyA6ICdyZW5kZXJlci9hbnlfZm9sZGVyJ31cImA7XG4gICAgfVxuXG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KFxuICAgICAgcGF0aC5yZXNvbHZlKFxuICAgICAgICB0aGlzLndlYnBhY2tEaXIsXG4gICAgICAgIGluUmVuZGVyZXJEaXIgPyAnbWFpbicgOiAncmVuZGVyZXInLFxuICAgICAgICBpblJlbmRlcmVyRGlyID8gJy4nIDogJ2FueV9mb2xkZXInLFxuICAgICAgKSxcbiAgICApO1xuICB9XG5cbiAgZ2V0RGVmaW5lcyhpblJlbmRlcmVyRGlyID0gdHJ1ZSkge1xuICAgIGNvbnN0IGRlZmluZXM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nOyB9ID0ge1xuICAgICAgQVNTRVRfUkVMT0NBVE9SX0JBU0VfRElSOiB0aGlzLmFzc2V0UmVsb2NhdG9yQmFzZURpcihpblJlbmRlcmVyRGlyKSxcbiAgICB9O1xuICAgIGlmIChcbiAgICAgICF0aGlzLnBsdWdpbkNvbmZpZy5yZW5kZXJlci5lbnRyeVBvaW50c1xuICAgICAgfHwgIUFycmF5LmlzQXJyYXkodGhpcy5wbHVnaW5Db25maWcucmVuZGVyZXIuZW50cnlQb2ludHMpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVpcmVkIGNvbmZpZyBvcHRpb24gXCJyZW5kZXJlci5lbnRyeVBvaW50c1wiIGhhcyBub3QgYmVlbiBkZWZpbmVkJyk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgZW50cnlQb2ludCBvZiB0aGlzLnBsdWdpbkNvbmZpZy5yZW5kZXJlci5lbnRyeVBvaW50cykge1xuICAgICAgY29uc3QgZW50cnlLZXkgPSB0aGlzLnRvRW52aXJvbm1lbnRWYXJpYWJsZShlbnRyeVBvaW50KTtcbiAgICAgIGlmIChlbnRyeVBvaW50Lmh0bWwpIHtcbiAgICAgICAgZGVmaW5lc1tlbnRyeUtleV0gPSB0aGlzLnJlbmRlcmVyRW50cnlQb2ludChlbnRyeVBvaW50LCBpblJlbmRlcmVyRGlyLCAnaW5kZXguaHRtbCcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGVmaW5lc1tlbnRyeUtleV0gPSB0aGlzLnJlbmRlcmVyRW50cnlQb2ludChlbnRyeVBvaW50LCBpblJlbmRlcmVyRGlyLCAnaW5kZXguanMnKTtcbiAgICAgIH1cbiAgICAgIGRlZmluZXNbYHByb2Nlc3MuZW52LiR7ZW50cnlLZXl9YF0gPSBkZWZpbmVzW2VudHJ5S2V5XTtcblxuICAgICAgY29uc3QgcHJlbG9hZERlZmluZUtleSA9IHRoaXMudG9FbnZpcm9ubWVudFZhcmlhYmxlKGVudHJ5UG9pbnQsIHRydWUpO1xuICAgICAgZGVmaW5lc1twcmVsb2FkRGVmaW5lS2V5XSA9IHRoaXMuZ2V0UHJlbG9hZERlZmluZShlbnRyeVBvaW50KTtcbiAgICAgIGRlZmluZXNbYHByb2Nlc3MuZW52LiR7cHJlbG9hZERlZmluZUtleX1gXSA9IGRlZmluZXNbcHJlbG9hZERlZmluZUtleV07XG4gICAgfVxuICAgIHJldHVybiBkZWZpbmVzO1xuICB9XG5cbiAgc291cmNlTWFwT3B0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmlzUHJvZCA/ICdzb3VyY2UtbWFwJyA6ICdldmFsLXNvdXJjZS1tYXAnO1xuICB9XG5cbiAgZ2V0TWFpbkNvbmZpZygpIHtcbiAgICBjb25zdCBtYWluQ29uZmlnID0gdGhpcy5yZXNvbHZlQ29uZmlnKHRoaXMucGx1Z2luQ29uZmlnLm1haW5Db25maWcpO1xuXG4gICAgaWYgKCFtYWluQ29uZmlnLmVudHJ5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVpcmVkIG9wdGlvbiBcIm1haW5Db25maWcuZW50cnlcIiBoYXMgbm90IGJlZW4gZGVmaW5lZCcpO1xuICAgIH1cbiAgICBjb25zdCBmaXggPSAoaXRlbTogRW50cnlUeXBlKTogRW50cnlUeXBlID0+IHtcbiAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycpIHJldHVybiAoZml4KFtpdGVtXSkgYXMgc3RyaW5nW10pWzBdO1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkpIHtcbiAgICAgICAgcmV0dXJuIGl0ZW0ubWFwKCh2YWwpID0+ICh2YWwuc3RhcnRzV2l0aCgnLi8nKSA/IHBhdGgucmVzb2x2ZSh0aGlzLnByb2plY3REaXIsIHZhbCkgOiB2YWwpKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJldDogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgc3RyaW5nW10+ID0ge307XG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhpdGVtKSkge1xuICAgICAgICByZXRba2V5XSA9IGZpeChpdGVtW2tleV0pIGFzIHN0cmluZyB8IHN0cmluZ1tdO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuICAgIG1haW5Db25maWcuZW50cnkgPSBmaXgobWFpbkNvbmZpZy5lbnRyeSBhcyBFbnRyeVR5cGUpO1xuXG4gICAgcmV0dXJuIHdlYnBhY2tNZXJnZSh7XG4gICAgICBkZXZ0b29sOiAnc291cmNlLW1hcCcsXG4gICAgICB0YXJnZXQ6ICdlbGVjdHJvbi1tYWluJyxcbiAgICAgIG1vZGU6IHRoaXMubW9kZSxcbiAgICAgIG91dHB1dDoge1xuICAgICAgICBwYXRoOiBwYXRoLnJlc29sdmUodGhpcy53ZWJwYWNrRGlyLCAnbWFpbicpLFxuICAgICAgICBmaWxlbmFtZTogJ2luZGV4LmpzJyxcbiAgICAgICAgbGlicmFyeVRhcmdldDogJ2NvbW1vbmpzMicsXG4gICAgICB9LFxuICAgICAgcGx1Z2luczogW1xuICAgICAgICBuZXcgd2VicGFjay5EZWZpbmVQbHVnaW4odGhpcy5nZXREZWZpbmVzKCkpLFxuICAgICAgXSxcbiAgICAgIG5vZGU6IHtcbiAgICAgICAgX19kaXJuYW1lOiBmYWxzZSxcbiAgICAgICAgX19maWxlbmFtZTogZmFsc2UsXG4gICAgICB9LFxuICAgICAgcmVzb2x2ZToge1xuICAgICAgICBtb2R1bGVzOiBbXG4gICAgICAgICAgcGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZSh0aGlzLndlYnBhY2tEaXIpLCAnLi8nKSxcbiAgICAgICAgICBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKHRoaXMud2VicGFja0RpciksICdub2RlX21vZHVsZXMnKSxcbiAgICAgICAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnbm9kZV9tb2R1bGVzJyksXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIH0sIG1haW5Db25maWcgfHwge30pO1xuICB9XG5cbiAgYXN5bmMgZ2V0UHJlbG9hZFJlbmRlcmVyQ29uZmlnKFxuICAgIHBhcmVudFBvaW50OiBXZWJwYWNrUGx1Z2luRW50cnlQb2ludCxcbiAgICBlbnRyeVBvaW50OiBXZWJwYWNrUHJlbG9hZEVudHJ5UG9pbnQsXG4gICkge1xuICAgIGNvbnN0IHJlbmRlcmVyQ29uZmlnID0gdGhpcy5yZXNvbHZlQ29uZmlnKHRoaXMucGx1Z2luQ29uZmlnLnJlbmRlcmVyLmNvbmZpZyk7XG4gICAgY29uc3QgcHJlZml4ZWRFbnRyaWVzID0gZW50cnlQb2ludC5wcmVmaXhlZEVudHJpZXMgfHwgW107XG5cbiAgICByZXR1cm4gd2VicGFja01lcmdlKHtcbiAgICAgIGRldnRvb2w6IHRoaXMuc291cmNlTWFwT3B0aW9uKCksXG4gICAgICBtb2RlOiB0aGlzLm1vZGUsXG4gICAgICBlbnRyeTogcHJlZml4ZWRFbnRyaWVzLmNvbmNhdChbXG4gICAgICAgIGVudHJ5UG9pbnQuanMsXG4gICAgICBdKSxcbiAgICAgIG91dHB1dDoge1xuICAgICAgICBwYXRoOiBwYXRoLnJlc29sdmUodGhpcy53ZWJwYWNrRGlyLCAncmVuZGVyZXInLCBwYXJlbnRQb2ludC5uYW1lKSxcbiAgICAgICAgZmlsZW5hbWU6ICdwcmVsb2FkLmpzJyxcbiAgICAgIH0sXG4gICAgICBub2RlOiB7XG4gICAgICAgIF9fZGlybmFtZTogZmFsc2UsXG4gICAgICAgIF9fZmlsZW5hbWU6IGZhbHNlLFxuICAgICAgfSxcbiAgICB9LFxuICAgIHJlbmRlcmVyQ29uZmlnIHx8IHt9LFxuICAgIHsgdGFyZ2V0OiAnZWxlY3Ryb24tcHJlbG9hZCcgfSk7XG4gIH1cblxuICBhc3luYyBnZXRSZW5kZXJlckNvbmZpZyhlbnRyeVBvaW50czogV2VicGFja1BsdWdpbkVudHJ5UG9pbnRbXSkge1xuICAgIGNvbnN0IHJlbmRlcmVyQ29uZmlnID0gdGhpcy5yZXNvbHZlQ29uZmlnKHRoaXMucGx1Z2luQ29uZmlnLnJlbmRlcmVyLmNvbmZpZyk7XG4gICAgY29uc3QgZW50cnk6IHdlYnBhY2suRW50cnkgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGVudHJ5UG9pbnQgb2YgZW50cnlQb2ludHMpIHtcbiAgICAgIGNvbnN0IHByZWZpeGVkRW50cmllcyA9IGVudHJ5UG9pbnQucHJlZml4ZWRFbnRyaWVzIHx8IFtdO1xuICAgICAgZW50cnlbZW50cnlQb2ludC5uYW1lXSA9IHByZWZpeGVkRW50cmllc1xuICAgICAgICAuY29uY2F0KFtlbnRyeVBvaW50LmpzXSk7XG4gICAgfVxuXG4gICAgY29uc3QgZGVmaW5lcyA9IHRoaXMuZ2V0RGVmaW5lcyhmYWxzZSk7XG4gICAgY29uc3QgcGx1Z2lucyA9IGVudHJ5UG9pbnRzLmZpbHRlcigoZW50cnlQb2ludCkgPT4gQm9vbGVhbihlbnRyeVBvaW50Lmh0bWwpKVxuICAgICAgLm1hcCgoZW50cnlQb2ludCkgPT4gbmV3IEh0bWxXZWJwYWNrUGx1Z2luKHtcbiAgICAgICAgdGl0bGU6IGVudHJ5UG9pbnQubmFtZSxcbiAgICAgICAgdGVtcGxhdGU6IGVudHJ5UG9pbnQuaHRtbCxcbiAgICAgICAgZmlsZW5hbWU6IGAke2VudHJ5UG9pbnQubmFtZX0vaW5kZXguaHRtbGAsXG4gICAgICAgIGNodW5rczogW2VudHJ5UG9pbnQubmFtZV0uY29uY2F0KGVudHJ5UG9pbnQuYWRkaXRpb25hbENodW5rcyB8fCBbXSksXG4gICAgICB9KSBhcyBXZWJwYWNrUGx1Z2luSW5zdGFuY2UpLmNvbmNhdChbbmV3IHdlYnBhY2suRGVmaW5lUGx1Z2luKGRlZmluZXMpXSk7XG4gICAgcmV0dXJuIHdlYnBhY2tNZXJnZSh7XG4gICAgICBlbnRyeSxcbiAgICAgIGRldnRvb2w6IHRoaXMuc291cmNlTWFwT3B0aW9uKCksXG4gICAgICB0YXJnZXQ6IFsnd2ViJywgJ2VsZWN0cm9uLXJlbmRlcmVyJ10sXG4gICAgICBtb2RlOiB0aGlzLm1vZGUsXG4gICAgICBvdXRwdXQ6IHtcbiAgICAgICAgcGF0aDogcGF0aC5yZXNvbHZlKHRoaXMud2VicGFja0RpciwgJ3JlbmRlcmVyJyksXG4gICAgICAgIGZpbGVuYW1lOiAnW25hbWVdL2luZGV4LmpzJyxcbiAgICAgICAgZ2xvYmFsT2JqZWN0OiAnc2VsZicsXG4gICAgICAgIC4uLih0aGlzLmlzUHJvZCA/IHt9IDogeyBwdWJsaWNQYXRoOiAnLycgfSksXG4gICAgICB9LFxuICAgICAgbm9kZToge1xuICAgICAgICBfX2Rpcm5hbWU6IGZhbHNlLFxuICAgICAgICBfX2ZpbGVuYW1lOiBmYWxzZSxcbiAgICAgIH0sXG4gICAgICBwbHVnaW5zLFxuICAgIH0sIHJlbmRlcmVyQ29uZmlnIHx8IHt9KTtcbiAgfVxufVxuIl19